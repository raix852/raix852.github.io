<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Raix&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="My garden, my knowledge, my soul.">
<meta property="og:type" content="website">
<meta property="og:title" content="Raix's Blog">
<meta property="og:url" content="http://raix852.github.io/index.html">
<meta property="og:site_name" content="Raix's Blog">
<meta property="og:description" content="My garden, my knowledge, my soul.">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Raix's Blog">
<meta name="twitter:description" content="My garden, my knowledge, my soul.">
  
    <link rel="alternate" href="/atom.xml" title="Raix&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Raix&#39;s Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">知識不經整理，無法累積。智慧不經思考，無法成長。</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://raix852.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-gitlab-ci" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/05/03/gitlab-ci/" class="article-date">
  <time datetime="2017-05-03T15:00:00.000Z" itemprop="datePublished">2017-05-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/05/03/gitlab-ci/">使用 Gitlab CI</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近有私人專案使用 gitlab 作為存放處，為此去研究 gitlab 有什麼工具可以整合 CI 。在這方面 gitlab 有提供自己的 Gitlab CI 功能，可以很方便的設定和整合。</p>
<h2 id="準備專案"><a href="#準備專案" class="headerlink" title="準備專案"></a>準備專案</h2><p>在 gitlab 建立帳號後，建立自己的專案起來。這裏我使用的範例程式是一個簡單的 sqlite3 python 函式庫，功能為建立一個 db 存放文章資訊和查詢使用，以及針對這些功能做單元測試。</p>
<ul>
<li>專案連結： <a href="https://gitlab.com/raix852/my-ci-project" target="_blank" rel="external">my-ci-project</a></li>
</ul>
<h2 id="設定-Gitlab-CI"><a href="#設定-Gitlab-CI" class="headerlink" title="設定 Gitlab CI"></a>設定 Gitlab CI</h2><ul>
<li><a href="https://docs.gitlab.com/ce/ci/" target="_blank" rel="external">GitLab CI 官方文件</a></li>
</ul>
<ol>
<li><p>建立 <code>.gitlab-ci.yml</code> 檔案。</p>
<p><code>.gitlab-ci.yml</code> 是用來設定 CI 的行為，設定好以後會由 <strong>Runner</strong> 啟動 job 來執行 <code>.gitlab-ci.yml</code> 定義的行為，預設會在 pipeline 裡執行 3 個階段： <code>build</code>, <code>test</code>, <code>deploy</code>，沒有設定的階段在執行時會忽略。 <code>.gitlab-ci.yml</code> 需放在專案的 root 資料夾下。</p>
</li>
<li><p>設定 <code>.gitlab-ci.yml</code></p>
<p>這裏我拿官方提供的 bash template 來修改，原始設定如下。更多其他 template 可以從 project 首頁 -&gt; Set up CI -&gt; Apply a GitLab CI Yaml template 下拉選單選擇。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># This file is a template, and might need editing before it works on your project.</span></div><div class="line"><span class="comment"># see https://docs.gitlab.com/ce/ci/yaml/README.html for all available options</span></div><div class="line"></div><div class="line"><span class="comment"># you can delete this line if you're not using Docker</span></div><div class="line">image: busybox:latest</div><div class="line"></div><div class="line">before_script:</div><div class="line">   - <span class="built_in">echo</span> <span class="string">"Before script section"</span></div><div class="line">   - <span class="built_in">echo</span> <span class="string">"For example you might run an update here or install a build dependency"</span></div><div class="line">   - <span class="built_in">echo</span> <span class="string">"Or perhaps you might print out some debugging details"</span></div><div class="line"></div><div class="line">after_script:</div><div class="line">  - <span class="built_in">echo</span> <span class="string">"After script section"</span></div><div class="line">  - <span class="built_in">echo</span> <span class="string">"For example you might do some cleanup here"</span></div><div class="line"></div><div class="line">build1:</div><div class="line"> stage: build</div><div class="line"> script:</div><div class="line">   - <span class="built_in">echo</span> <span class="string">"Do your build here"</span></div><div class="line"></div><div class="line"><span class="built_in">test</span>1:</div><div class="line"> stage: <span class="built_in">test</span></div><div class="line"> script:</div><div class="line">   - <span class="built_in">echo</span> <span class="string">"Do a test here"</span></div><div class="line">   - <span class="built_in">echo</span> <span class="string">"For example run a test suite"</span></div><div class="line"></div><div class="line"><span class="built_in">test</span>2:</div><div class="line"> stage: <span class="built_in">test</span></div><div class="line"> script:</div><div class="line">   - <span class="built_in">echo</span> <span class="string">"Do another parallel test here"</span></div><div class="line">   - <span class="built_in">echo</span> <span class="string">"For example run a lint test"</span></div><div class="line"></div><div class="line">deploy1:</div><div class="line"> stage: deploy</div><div class="line"> script:</div><div class="line">   - <span class="built_in">echo</span> <span class="string">"Do your deploy here"</span></div></pre></td></tr></table></figure>
<p>修改後如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 要使用 docker image，不使用 docker 環境可刪除這行。</span></div><div class="line">image: ubuntu:16.04</div><div class="line"></div><div class="line">before_script:</div><div class="line"><span class="comment"># 在工作開始之前需要準備的東西</span></div><div class="line">  - apt-get update &amp;&amp; apt-get install -y python</div><div class="line"></div><div class="line">after_script:</div><div class="line"><span class="comment"># 工作結束之後需要做的事情</span></div><div class="line">  - <span class="built_in">echo</span> <span class="string">"After script section"</span></div><div class="line">  - rm *.db</div><div class="line"></div><div class="line">build:</div><div class="line"><span class="comment"># 設定 tag: build， stage 為 build，設定需要在 build 階段做的事情</span></div><div class="line"> stage: build</div><div class="line"> script:</div><div class="line">   - <span class="built_in">echo</span> <span class="string">"Dry run python"</span></div><div class="line">   - python lib/sqlite_db.py</div><div class="line"></div><div class="line"><span class="built_in">test</span>:</div><div class="line"><span class="comment"># 設定 tag: test， stage 為 test，設定需要在 test 階段做的事情</span></div><div class="line"> stage: <span class="built_in">test</span></div><div class="line"> script:</div><div class="line">   - <span class="built_in">echo</span> <span class="string">"Do a test here"</span></div><div class="line">   - python <span class="built_in">test</span>/<span class="built_in">test</span>_sqlite_db.py</div></pre></td></tr></table></figure>
</li>
<li><p>Push <code>.gitlab-ci.yml</code> to GitLab</p>
<p>將 <code>.gitlab-ci.yml</code> commit 到 project 並 push 到 gitlab 上後，就會啟動 Runner 來執行 <code>.gitlab-ci.yml</code> 所設定的工作。</p>
</li>
</ol>
<h2 id="設定-Runner"><a href="#設定-Runner" class="headerlink" title="設定 Runner"></a>設定 Runner</h2><p>在 Gitlab CI 裡， Runner 可以是 virtual machine，可以是 bare-metal machine，可以是 docker container 或者是 cluster of containers。使用 Runner 時可以使用官方的雲端平台，或者本地端自建私有環境，</p>
<ol>
<li><p>使用官方雲端平台</p>
<p>使用官方雲端平台相當簡單，只要在 Project Settings -&gt; CI/CD Pipelines -&gt; Enable Shared Runners ，即可當 Project 有任何更動時，會自動選擇可用的環境來啟動 Runner 執行工作。</p>
</li>
<li><p>自建私有環境</p>
<p>參考 <a href="https://docs.gitlab.com/runner/install/" target="_blank" rel="external">Install GitLab Runner</a> ，選擇要建立的環境安裝步驟。比較需要注意的是 registration token 在 Project Settings -&gt; CI/CD Pipelines 可以找到。</p>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://raix852.github.io/2017/05/03/gitlab-ci/" data-id="cj29ugzvu000sdlr195rseert" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CI/">CI</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/gitlab/">gitlab</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-slackbot" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/04/17/slackbot/" class="article-date">
  <time datetime="2017-04-17T14:30:00.000Z" itemprop="datePublished">2017-04-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/17/slackbot/">建立 Slack Bot</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="註冊與建立-Slack-App"><a href="#註冊與建立-Slack-App" class="headerlink" title="註冊與建立 Slack App"></a>註冊與建立 Slack App</h2><p>到 <a href="https://api.slack.com/slack-apps" target="_blank" rel="external">Building Slack apps</a> 裡，點選 <strong>Create a Slack app</strong> 按鈕，輸入 <strong>App Name</strong> 和選擇在哪一個 Team ，如下圖。</p>
<p><img src="http://i.imgur.com/2Unug0m.jpg" alt="Create an App"></p>
<p>接著點選 <strong>Bots</strong> ，進入加入 Bot User 頁面。</p>
<p><img src="http://i.imgur.com/kgTeLoK.jpg" alt="Bots"></p>
<p>點選 <strong>Add Bot User</strong> 按鈕，輸入要給 Bot 的名稱。</p>
<p><img src="http://i.imgur.com/pCRgtbV.jpg" alt="Add Bot User"></p>
<p>回到 <strong>Basic Information</strong> 頁面來，下拉 <strong>Install your app to your team</strong> ，點選 <strong>Install App to Team</strong> 來產生 token 。點進去會進入確認頁面，點選 <strong>Authorize</strong> 。</p>
<p><img src="http://i.imgur.com/YqhuM8F.jpg" alt="Install App to Team"></p>
<p>安裝 App 完畢後回到 <strong>Basic Information</strong> ，在 <strong>Add features and functionality</strong> 裡 <strong>Permission</strong> 選項，點進去可以拿到 <strong>OAuth Access Token</strong> 和 <strong>Bot User OAuth Access Token</strong>。或者可以從左邊選項列表中的 <strong>Features</strong> 選擇 <strong>OAuth &amp; Permission</strong> 進去。</p>
<p><img src="http://i.imgur.com/0Sz9G5t.jpg" alt="OAuth &amp; Permission"></p>
<p>在 Slack 提供的 Api 裡，有些 method 只有擁有特定的權限才能使用，因此視開發的用途需要在 <strong>OAuth &amp; Permission</strong> 底下的 <strong>Permission Scopes</strong> 設定需要的權限。這些權限如果 App 需要公開給第三方使用時就會經過 Slack 審查是否合適，私人使用沒有限制。</p>
<p><img src="http://i.imgur.com/GTafSc1.jpg" alt="Permission Scopes"></p>
<p>以要建立聊天機器人來說，需要開通 <code>chat:write:bot</code> 權限才能送訊息到 slack channel。</p>
<p>設定好 <strong>Permission Scopes</strong> 後，需要在底下按下 <strong>Revoke Tokens</strong> 按鈕。然後重新 install app ，產生新的 token ，設定的權限才會生效。</p>
<p><img src="http://i.imgur.com/JyMOYbM.jpg" alt="Revoke Tokens"></p>
<h2 id="使用-python-lib"><a href="#使用-python-lib" class="headerlink" title="使用 python lib"></a>使用 python lib</h2><p>使用 <a href="https://slackapi.github.io/python-slackclient/" target="_blank" rel="external">slackclient</a> 這套 lib 可以快速讓 bot 可以在頻道上發話。</p>
<h3 id="安裝"><a href="#安裝" class="headerlink" title="安裝"></a>安裝</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install slackclient</div></pre></td></tr></table></figure>
<h3 id="使用範例"><a href="#使用範例" class="headerlink" title="使用範例"></a>使用範例</h3><p>送訊息到 <code>#general</code> 頻道上。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> slackclient <span class="keyword">import</span> SlackClient</div><div class="line"></div><div class="line">slack_token = <span class="string">"OAuth Access Token"</span></div><div class="line"></div><div class="line">sc = SlackClient(slack_token)</div><div class="line"></div><div class="line">sc.api_call(</div><div class="line">  <span class="string">"chat.postMessage"</span>,</div><div class="line">  channel=<span class="string">"#general"</span>,</div><div class="line">  text=<span class="string">"Hello from Python! :tada:"</span></div><div class="line">)</div></pre></td></tr></table></figure>
<p>簡單的幾段 code 就完成了一個可以發話的機器人。</p>
<h2 id="使用官方-API-送訊息"><a href="#使用官方-API-送訊息" class="headerlink" title="使用官方 API 送訊息"></a>使用官方 API 送訊息</h2><p>這邊是使用官方提供的 api 來送訊息，參閱網頁為:<a href="https://api.slack.com/methods" target="_blank" rel="external">API Methods</a>，並使用 <code>requests</code> 這套 http lib 來送出訊息。範例 code 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> requests</div><div class="line"><span class="keyword">import</span> json</div><div class="line"></div><div class="line">slack_token = <span class="string">"OAuth Access Token"</span></div><div class="line"></div><div class="line">param = &#123;<span class="string">"token"</span>: slack_token, <span class="string">"channel"</span> : <span class="string">"#general"</span>, <span class="string">"text"</span>: <span class="string">"Hello from Python! :tada:"</span>&#125;</div><div class="line">r = requests.get(<span class="string">"https://slack.com/api/chat.postMessage"</span>, params=param)</div></pre></td></tr></table></figure>
<h2 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h2><p>如要做個發話機器人，slack 提供的資源可以簡單地讓開發者快速有個雛形。要繼續深入使用各種 API 來做功能的話，就需要開始注意各個 API 所需要的權限，以及了解 API 回應的資料格式，這部分就需要細心研究了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://raix852.github.io/2017/04/17/slackbot/" data-id="cj29ugzvs000qdlr1qr4llfdk" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Bot/">Bot</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-deeplearning-ch1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/02/03/deeplearning-ch1/" class="article-date">
  <time datetime="2017-02-03T02:30:00.000Z" itemprop="datePublished">2017-02-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/02/03/deeplearning-ch1/">Deep learning 讀書筆記 - CH. 1</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="目標"><a href="#目標" class="headerlink" title="目標"></a>目標</h2><p>今年的目標是進一步學習 Deep learning ，利用 <a href="http://www.deeplearningbook.org/" target="_blank" rel="external">Deep Learning - An MIT Press Book</a> 當作學習的教材。</p>
<h2 id="第一章-Introduction"><a href="#第一章-Introduction" class="headerlink" title="第一章 - Introduction"></a>第一章 - Introduction</h2><p>在早期 AI 發展的時代，電腦擅長於處理人們不擅長的事物，像是計算複雜的公式、重複許多次的作業。但是真正有挑戰的是對人們擅長的事物但是難以正規地描述，像是辨識物品、了解語言。</p>
<p>要處理這些對人們擅長但是電腦難以描述的問題，解決方案是讓電腦可以從經驗上學習，並且能透過建立層層的概念起來了解世界。一層一層的概念從簡單的開始逐漸堆積，每一層由前一層較簡單的概念轉成複雜的概念，越上層就是越複雜的概念，以此讓電腦可以學習到複雜的概念。這些概念層會有很多 layer ，呈現的 graph 也很 deep ，因此叫做 AI Deep learning 。</p>
<p>早期 AI 成功是基於有限的環境和明確的條件下，例如 IBM Deep Blue(1997) 擊敗西洋棋冠軍 Garry Kasparov 。在西洋棋的環境中，只有 64 個位置和32個受規則限制棋子可以移動的地方。因此只要工程師將每條規則和公式詳細規劃出來，透過當時的運算力即可達成此一創舉。因此這種具有抽象的計算概念和有正式的規則對電腦而言就非常的簡單，而且處理的環境有限，因此可以在 1996 年時就成功擊敗人類。但是直到最近幾年，電腦識別物品才成功到達人類的精確度。</p>
<p>有不少 AI project 是透過人工建立的知識庫，透過條件判斷和邏輯推導公式將知識編成一條條規則，這種方式稱為 knowledge base approach 。但是沒有一個取得巨大的成功。</p>
<p>由於在 knowledge base 遇到的困難，產生了由 AI 自己學習自己的知識庫，脫離人工建立的模式，此種方式就稱為 Machine learning 。簡單的 logistic regression 可以用來是否需要 cesarean delivery (查一下是剖腹產)，簡易的 navie Bayes 可以用來區分是否為垃圾郵件。這些簡單的 machine learning 演算法依賴於資料的 representation ，representation 裡所含有的部分資訊稱為 feature。在 Machine learning 裡，選擇好的 representation 對演算法的表現會有很大的影響。許多問題只要提供好的一組 features 作為 representation ，就能被簡單的 Machine learning 演算法解決。</p>
<p>但是更多的問題是難以知道如何抽出 features 出來。假如要設計出一個能辨識出車子的程式，我們知道車子有輪子，所以我們可以用輪子當作 feature ，不幸的是我們難以描述輪子看起來會是怎樣，畢竟在圖片上輪子會因角度不同呈現不同的幾何樣貌，以及會受到光影的影響，或是被擋泥板遮住部分，因此無法成功設計成一個 feature 使用。</p>
<p>一個解決的方式是不只去發現問題的 representation 對應輸出結果的本身 ，而且也要自己學習出問題的 representation ，這種方式稱為 representation learning 。學習出來的 representation 通常會比人工設計出來的表現較佳，而且可以通用於較多的問題上，減少人為的介入。 Representation 對簡單的問題可以幾分鐘能就學習出一組好的 feature 出來，而人為設計則需花費無數倍的時間。</p>
<p>典型的  案例是 autoencoder ， autoencoder 結合了 encoder 和 decoder ， encoder 負責將 input 轉成 representation ， decoder 負責將 representation 轉回原來的樣子。 Autoencoder 學習目標就是盡可能在這兩個轉換中減少資訊的損失，並且學習出一個好的 representation 涵蓋許多好的 properties 。</p>
<p>當設計 futures 或演算法去學習 features ，通常目標是區分出可以解釋 observed data 的 factors of variation 。 Factor 可簡單的解釋成對原始資料的影響力。每個 factor 影響程度可能存在未知的作用造成最後觀察的結果，無法輕易的量化或運算。因此對真實世界的 artificial intelligence 來說，有多少 factors of variation 影響每一小片段觀察的結果，是主要困難點的地方。當難以學習到 representation 時， representation learning 就無法提供有用的幫助。</p>
<p>Deep learning 透過將 representations 轉成另一些較簡單的 representations 來解決這些困難的問題，可以經由較簡單的概念堆積成較複雜的概念。如下圖所示<br><img src="http://i.imgur.com/W18bldS.png" alt="Figure 1.2:Illustration of deep learning model - Deep Learning CH.1 P.6"></p>
<p>基礎的 Deep learning model 是 feedforward deep network 或稱為 multilayer perceptron (MLP) 。一個 multilayer perceptron 是經由一個數學函式將一組 input 對應到一組 output 。這個函式由許多簡單的函式組合而成，可以將之想像成不同的函式提供新的 representations 來表示 input 。</p>
<p>學習正確的 representations 是一個觀點，另一個觀點是 depth 可以讓電腦學習出多步驟的程式，每一層產出的 representations 視為是一組指令執行完後所保留的 memory ，越多層可以執行的指令組越多。根據這樣的觀點，每一層的產出就不一定需要 encode 成 factors of variation 來解釋 input 。可以是儲存執行過程中的狀態。</p>
<p>Deep learning 的深度有兩種計量方式。第一種是有多少在序列上的指令需要執行。可以想成是由 input 到 output 所經過的最常路徑長度。另一種是由 deep probabilistic models 使用，是根據有多少 concepts 彼此關聯，根據此種方式計算出來的 representations 有可能比 graph 上的 concepts 更深。比如說有一個 AI 系統想要偵測人眼，給一張被陰影遮住半邊的臉，此系統首先要先偵測人臉，接著找出一隻眼睛的位置，如此來推測出另一眼睛可能也存在。這種方式只有兩層，一層偵測人臉，一層偵測眼睛，但是每一層裡會有 n 層來計算這些特徵。因此以第一種方式來測會是 2n 的長度。因此對 Deep learning 深度並沒有一個正確的答案，但是 deep learning 可以被指稱為比傳統 machine learning 包含更多學習函式的組成或學習到的觀念。</p>
<p>總結來說，deep learning 是一種 AI 的方法，一種 machine learning 的類型，一種技術讓電腦可以從經驗中、從資料中學習。 Machine learning 是目前 AI 系統中，較可以適應於複雜的世界之上。 Deep learning 更是其中的佼佼者，可以展現出強大和具有彈性的能力學習複雜交錯的概念。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://raix852.github.io/2017/02/03/deeplearning-ch1/" data-id="cj29ugzvn000odlr1g741kenv" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Deep-Learning/">Deep Learning</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Machine-Learning/">Machine Learning</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-ldap" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/11/01/ldap/" class="article-date">
  <time datetime="2016-11-01T13:30:00.000Z" itemprop="datePublished">2016-11-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/01/ldap/">LDAP 介紹與架設</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="What-is-LDAP"><a href="#What-is-LDAP" class="headerlink" title="What is LDAP?"></a>What is LDAP?</h2><p>LDAP 全名為 Lightweight Directory Access Protocol (輕型目錄訪問協議)，目前應用在很多企業裡面，作為一個中央控管的帳號管理工具，可用來根據組織架構做權限的劃分。LDAP 可以透過網路連結多台電腦，或是串接各種有支援 LDAP 的 services，統一為帳號做驗證，因此能夠提供一致的帳號管理。</p>
<h2 id="安裝"><a href="#安裝" class="headerlink" title="安裝"></a>安裝</h2><p>在 centos 7上安裝 ldap server / clients 套件。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install -y openldap openldap-servers openldap-clients openldap-devel</div></pre></td></tr></table></figure>
<h2 id="設定-slapd"><a href="#設定-slapd" class="headerlink" title="設定 slapd"></a>設定 slapd</h2><p>slapd - Stand-alone LDAP Daemon，啟動後 listen LDAP connections ，處理和回應 LDAP 操作。</p>
<ul>
<li>OpenLDAP 在 2.3 之後不使用 <code>/etc/openldap/slapd.conf</code> ，但是有提供工具轉換成現在的格式，因此採取的作法是去找設定好的 slapd.conf 當做範例，之後再使用 openldap 提供的指令轉換過去。</li>
<li><a href="http://www.openldap.org/doc/admin24/slapdconfig.html" target="_blank" rel="external">The slapd Configuration File</a></li>
</ul>
<p>以下做法是透過設定 slapd.conf 。</p>
<h3 id="設定-slapd-conf"><a href="#設定-slapd-conf" class="headerlink" title="設定 slapd.conf"></a>設定 slapd.conf</h3><p>設定 <code>cn=admin,dc=example,dc=com</code> 為擁有最高權限的帳號。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">database config</div><div class="line">access to attrs=userPassword</div><div class="line">	by self write</div><div class="line">	by anonymous auth</div><div class="line">	by dn.base=&quot;cn=admin,dc=example,dc=com&quot; write</div><div class="line">	by * none</div><div class="line">access to *</div><div class="line">	by self write</div><div class="line">	by dn.base=&quot;cn=admin,dc=example,dc=com&quot; manage</div><div class="line">	by * read</div><div class="line"></div><div class="line">database	bdb</div><div class="line">  access to *</div><div class="line">      by self write</div><div class="line">      by dn.base=&quot;cn=admin,dc=example,dc=com&quot; manage</div><div class="line">      by * read</div><div class="line"></div><div class="line">suffix		&quot;dc=example,dc=com&quot;</div><div class="line">rootdn		&quot;cn=admin,dc=example,dc=com&quot;</div><div class="line">rootpw    secret</div></pre></td></tr></table></figure>
<p>rootpw 這個欄位可以透過 <code>slappasswd -s secret</code> 產出 hash 值放進設定裡。<br>接著套用設定。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ rm -rf /etc/openldap/slapd.d/*</div><div class="line">$ cp /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG</div><div class="line">$ slaptest <span class="_">-f</span> /etc/openldap/slapd.conf -F /etc/openldap/slapd.d</div><div class="line">$ chown ldap:ldap -R /etc/openldap/slapd.d/</div></pre></td></tr></table></figure>
<p>透過 <code>systemctl</code> 啟動 slapd。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">systemctl enable slapd</div><div class="line">systemctl start slapd</div></pre></td></tr></table></figure>
<h2 id="LDAP-帳號"><a href="#LDAP-帳號" class="headerlink" title="LDAP 帳號"></a>LDAP 帳號</h2><p>LDAP 帳號具有階層性，如下圖。</p>
<p><img src="http://i.imgur.com/8LQCsAP.jpg" alt="LDAP Hierarchy"></p>
<p>最上層是 Base ，下層是 children ，也就是組織裡的中間單位，而最下層就會是使用者的名稱，由下往上追朔可以知道使用隸屬哪個單位，哪個部門，哪個組織。</p>
<h3 id="常見的縮寫"><a href="#常見的縮寫" class="headerlink" title="常見的縮寫"></a>常見的縮寫</h3><table>
<thead>
<tr>
<th>String</th>
<th>Attribute Type</th>
</tr>
</thead>
<tbody>
<tr>
<td>dn</td>
<td>Distinguished Name</td>
</tr>
<tr>
<td>cn</td>
<td>Common Name</td>
</tr>
<tr>
<td>o</td>
<td>Organisational Name</td>
</tr>
<tr>
<td>ou</td>
<td>Organisational Unit Name</td>
</tr>
<tr>
<td>dc</td>
<td>Domain Component</td>
</tr>
<tr>
<td>uid</td>
<td>User Identification</td>
</tr>
</tbody>
</table>
<h2 id="OpenLDAP-with-Linux"><a href="#OpenLDAP-with-Linux" class="headerlink" title="OpenLDAP with Linux"></a>OpenLDAP with Linux</h2><p>LDAP 帳號可以和 Linux 綁定，設定讓 LDAP 登入 Linux 。</p>
<h3 id="User"><a href="#User" class="headerlink" title="User"></a>User</h3><ul>
<li>posixAccount 對應到 <code>/etc/passwd</code></li>
</ul>
<table>
<thead>
<tr>
<th>/etc/passwd</th>
<th>posixAccount</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>uid</td>
</tr>
<tr>
<td>password</td>
<td>userPassword</td>
</tr>
<tr>
<td>uid</td>
<td>uidNumber</td>
</tr>
<tr>
<td>gid</td>
<td>gidNumber</td>
</tr>
<tr>
<td>full_name</td>
<td>gecos</td>
</tr>
<tr>
<td>Home Directory</td>
<td>homeDirectory</td>
</tr>
<tr>
<td>Login Shell</td>
<td>loginShell</td>
</tr>
</tbody>
</table>
<ul>
<li>shadowAccount 對應到 <code>/etc/shadow</code></li>
</ul>
<table>
<thead>
<tr>
<th>/etc/shadow</th>
<th>shadowAccount</th>
</tr>
</thead>
<tbody>
<tr>
<td>username</td>
<td>uid</td>
</tr>
<tr>
<td>password</td>
<td>userPassword</td>
</tr>
<tr>
<td>last</td>
<td>shadowLastChange</td>
</tr>
<tr>
<td>may</td>
<td>shadowMin</td>
</tr>
<tr>
<td>must</td>
<td>shadowMax</td>
</tr>
<tr>
<td>warn</td>
<td>shadowWarning</td>
</tr>
<tr>
<td>expire</td>
<td>shadowExpire</td>
</tr>
<tr>
<td>disable</td>
<td>shadowInactive</td>
</tr>
<tr>
<td>reservered</td>
<td>shadowFlag</td>
</tr>
</tbody>
</table>
<h3 id="Group"><a href="#Group" class="headerlink" title="Group"></a>Group</h3><ul>
<li>posixGroup 對應到 <code>/etc/group</code></li>
</ul>
<table>
<thead>
<tr>
<th>/etc/group</th>
<th>posixGroup</th>
</tr>
</thead>
<tbody>
<tr>
<td>group name</td>
<td>cn</td>
</tr>
<tr>
<td>password</td>
<td>userPassword</td>
</tr>
<tr>
<td>group id</td>
<td>gidNumber</td>
</tr>
<tr>
<td>other account</td>
<td>memberUid</td>
</tr>
</tbody>
</table>
<h3 id="安裝套件"><a href="#安裝套件" class="headerlink" title="安裝套件"></a>安裝套件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ yum install -y nscd nss-pam-ldapd</div></pre></td></tr></table></figure>
<h3 id="設定-ldap-conf"><a href="#設定-ldap-conf" class="headerlink" title="設定 ldap.conf"></a>設定 ldap.conf</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$ vim /etc/openldap/ldap.conf</div><div class="line"></div><div class="line"><span class="comment"># add at the last line</span></div><div class="line"><span class="comment"># LDAP server's URI</span></div><div class="line">URI ldap://localhost/</div><div class="line"></div><div class="line"><span class="comment"># specify Suffix</span></div><div class="line">BASE dc=example,dc=com</div></pre></td></tr></table></figure>
<h3 id="設定-nslcd-conf"><a href="#設定-nslcd-conf" class="headerlink" title="設定 nslcd.conf"></a>設定 nslcd.conf</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ vim /etc/nslcd.conf</div><div class="line"></div><div class="line">uri ldap://localhost/</div><div class="line">base dc=example,dc=com</div><div class="line">ssl no</div><div class="line">tls_cacertdir /etc/openldap/cacerts</div></pre></td></tr></table></figure>
<h3 id="設定-PAM"><a href="#設定-PAM" class="headerlink" title="設定 PAM"></a>設定 PAM</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$ vim /etc/pam.d/system-auth</div><div class="line"></div><div class="line">auth        sufficient    pam_ldap.so use_first_pass</div><div class="line">account     [default=bad success=ok user_unknown=ignore] pam_ldap.so</div><div class="line">password   sufficient    pam_ldap.so use_authtok</div><div class="line">session     optional      pam_ldap.so</div><div class="line"><span class="comment"># add if you need ( create home directory automatically if it's none )</span></div><div class="line">session     optional      pam_mkhomedir.so skel=/etc/skel <span class="built_in">umask</span>=077</div></pre></td></tr></table></figure>
<h3 id="設定-nsswitch-conf"><a href="#設定-nsswitch-conf" class="headerlink" title="設定 nsswitch.conf"></a>設定 nsswitch.conf</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ vim /etc/nsswitch.conf</div><div class="line"></div><div class="line">passwd: files ldap</div><div class="line">shadow: files ldap</div><div class="line">group: files ldap</div><div class="line">netgroup: ldap</div><div class="line">automount: files ldap</div></pre></td></tr></table></figure>
<h3 id="設定-authconfig"><a href="#設定-authconfig" class="headerlink" title="設定 authconfig"></a>設定 authconfig</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ vim /etc/sysconfig/authconfig</div><div class="line"></div><div class="line">USELDAP= yes</div></pre></td></tr></table></figure>
<h3 id="設定開機時啟動"><a href="#設定開機時啟動" class="headerlink" title="設定開機時啟動"></a>設定開機時啟動</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ systemctl <span class="built_in">enable</span> nslcd</div></pre></td></tr></table></figure>
<h2 id="建立和操作-LDAP-帳號"><a href="#建立和操作-LDAP-帳號" class="headerlink" title="建立和操作 LDAP 帳號"></a>建立和操作 LDAP 帳號</h2><p>以下是建立一個和 Linux 整合的帳號範例檔案 <code>user.ldif</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"># Domain Name</div><div class="line">dn: dc=example,dc=com</div><div class="line">dc: example</div><div class="line">objectClass: dcObject</div><div class="line">objectClass: organizationalUnit</div><div class="line">ou: example Dot com</div><div class="line"></div><div class="line"></div><div class="line"># User Organization Unit</div><div class="line">dn: ou=user,dc=example,dc=com</div><div class="line">ou: user</div><div class="line">objectClass: organizationalUnit</div><div class="line"></div><div class="line"># User: user01</div><div class="line">dn: uid=user01,ou=user,dc=example,dc=com</div><div class="line">objectClass: inetOrgPerson</div><div class="line">objectClass: posixAccount</div><div class="line">objectClass: shadowAccount</div><div class="line">userPassword: raix</div><div class="line">cn: user01</div><div class="line">uid: user01</div><div class="line">sn: user01</div><div class="line">uidNumber: 1000</div><div class="line">gidNumber: 1000</div><div class="line">homeDirectory: /home/user01</div><div class="line">loginShell: /bin/bash</div><div class="line"></div><div class="line"># Group</div><div class="line">dn: ou=group,dc=example,dc=com</div><div class="line">ou: group</div><div class="line">objectClass: organizationalUnit</div><div class="line"></div><div class="line"># User group</div><div class="line">dn: cn=uesr01,ou=group,dc=example,dc=com</div><div class="line">objectClass: posixGroup</div><div class="line">cn: user01</div><div class="line">gidNumber: 1000</div><div class="line">memberUid: user01</div></pre></td></tr></table></figure>
<ol>
<li>一開始先建立最上層的 Domain Name： <code>dc=example,dc=com</code>。</li>
<li>建立 <strong>user</strong> 組織單位，隸屬於 <code>dc=example,dc=com</code> domain 下。</li>
<li>建立 <strong>user01</strong> 帳號名稱，屬於 <strong>user</strong> 這個組織單位下。</li>
<li>接著建立出基本的使用者群組單位 <strong>group</strong></li>
<li>在 <strong>group</strong> 下建立出和 <strong>user01</strong> 同名的個人群組</li>
</ol>
<h3 id="加入帳號"><a href="#加入帳號" class="headerlink" title="加入帳號"></a>加入帳號</h3><p>使用 <code>ldapadd</code> 將 <code>user.ldif</code> 設定好的使用者帳號加入 LDAP。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ slapadd -v <span class="_">-l</span> /path/to/user.ldif</div></pre></td></tr></table></figure>
<h3 id="查詢帳號"><a href="#查詢帳號" class="headerlink" title="查詢帳號"></a>查詢帳號</h3><p>使用 <code>ldapsearch</code> 查詢 LDAP 資訊。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Search all users</span></div><div class="line">$ ldapsearch -x -LLL <span class="string">'(uid=*)'</span></div><div class="line"></div><div class="line"><span class="comment"># Search domain subtree</span></div><div class="line">$ ldapsearch -x -b <span class="string">'dc=example,dc=com'</span></div></pre></td></tr></table></figure>
<h3 id="更改帳號"><a href="#更改帳號" class="headerlink" title="更改帳號"></a>更改帳號</h3><p>使用 <code>ldapmodify</code> 更改 LDAP 資訊。<br>假設要將 <strong>user01</strong> 改名成 <strong>ldapuser</strong> ，建立一個 <code>modify_user.ldif</code> 檔案。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">dn: uid=user01,ou=user,dc=example,dc=com</div><div class="line">changetype: modrdn</div><div class="line">newrdn: uid=ldapuser</div><div class="line">deleteoldrdn: 1</div><div class="line"></div><div class="line">dn: uid=ldapuser,ou=user,dc=example,dc=com</div><div class="line">changetype: modify</div><div class="line">replace: cn</div><div class="line">cn: ldapuser</div><div class="line">-</div><div class="line">replace: uid</div><div class="line">uid: ldapuser</div><div class="line">-</div><div class="line">replace: sn</div><div class="line">sn: ldapuser</div></pre></td></tr></table></figure>
<p>接著套用這份設定檔。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ldapmodify -x <span class="_">-f</span> multichange.ldif</div></pre></td></tr></table></figure>
<h3 id="更改帳號密碼"><a href="#更改帳號密碼" class="headerlink" title="更改帳號密碼"></a>更改帳號密碼</h3><p>使用 <code>ldappasswd</code> 更改密碼。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ ldappasswd -x -D <span class="string">"uid=user01,ou=user,dc=example,dc=com"</span> -w old_passwd <span class="_">-a</span> old_passwd \</div><div class="line"> <span class="_">-s</span> new_passwd</div></pre></td></tr></table></figure>
<h2 id="設定-ppolicy"><a href="#設定-ppolicy" class="headerlink" title="設定 ppolicy"></a>設定 ppolicy</h2><p>使用 <code>slapd.conf</code> 設定檔來設定 ppolicy。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">$ vim /etc/openldap/slapd.conf</div><div class="line"></div><div class="line"><span class="comment">#-- Load schema</span></div><div class="line">include         /etc/openldap/schema/ppolicy.schema</div><div class="line"></div><div class="line"><span class="comment">#-- Load module</span></div><div class="line">moduleload ppolicy.la</div><div class="line"></div><div class="line"><span class="comment">#-- Load overlay</span></div><div class="line">overlay ppolicy</div><div class="line">ppolicy_default <span class="string">"cn=default,ou=Policies,dc=example,dc=com"</span></div><div class="line">ppolicy_use_lockout</div><div class="line">ppolicy_<span class="built_in">hash</span>_cleartext</div></pre></td></tr></table></figure>
<p>這樣表示預設的 policy 設定會落在 <code>cn=default,ou=Policies,dc=example,dc=com</code> 裡。<br>接著設定 ppolicy 規則。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">$ vim pwdpolicy.ldif</div><div class="line"></div><div class="line"><span class="comment"># Creates a Policies OU (Organizational Unit)</span></div><div class="line">dn: ou=Policies,dc=example,dc=com</div><div class="line">objectClass: organizationalUnit</div><div class="line">ou: Policies</div><div class="line"></div><div class="line"><span class="comment"># Creates a Policy object in Policies OU (Organizational Unit)</span></div><div class="line">dn: cn=default,ou=Policies,dc=example,dc=com</div><div class="line">objectClass: top</div><div class="line">objectClass: device</div><div class="line">objectClass: <span class="built_in">pwd</span>Policy</div><div class="line">cn: default</div><div class="line"><span class="built_in">pwd</span>Attribute: userPassword</div><div class="line"><span class="built_in">pwd</span>MaxAge: 3888000</div><div class="line"><span class="built_in">pwd</span>ExpireWarning: 604800</div><div class="line"><span class="built_in">pwd</span>InHistory: 3</div><div class="line"><span class="built_in">pwd</span>CheckQuality: 1</div><div class="line"><span class="built_in">pwd</span>M<span class="keyword">in</span>Length: 8</div><div class="line"><span class="built_in">pwd</span>MaxFailure: 5</div><div class="line"><span class="built_in">pwd</span>Lockout: TRUE</div><div class="line"><span class="built_in">pwd</span>LockoutDuration: 86400</div><div class="line"><span class="built_in">pwd</span>GraceAuthNLimit: 0</div><div class="line"><span class="built_in">pwd</span>FailureCountInterval: 0</div><div class="line"><span class="built_in">pwd</span>MustChange: TRUE</div><div class="line"><span class="built_in">pwd</span>AllowUserChange: TRUE</div><div class="line"><span class="built_in">pwd</span>SafeModify: FALSE</div></pre></td></tr></table></figure>
<p>加入 ppolicy 設定。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ldapadd -x -D <span class="string">"cn=admin,dc=example,dc=com"</span> -w secret <span class="_">-f</span> pwdpolicy.ldif</div></pre></td></tr></table></figure>
<h3 id="unlock-account"><a href="#unlock-account" class="headerlink" title="unlock account"></a>unlock account</h3><p>套用 ppolicy 之後，照設定帳號密碼嘗試錯誤達 5 次後帳號會鎖起來。<br>查詢被鎖起來的帳號。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ ldapsearch -x -D <span class="string">"cn=admin,dc=example,dc=com"</span> -w secret -x -b <span class="string">'dc=example,dc=com'</span> \</div><div class="line"> <span class="string">"pwdAccountLockedTime=*"</span> <span class="built_in">pwd</span>AccountLockedTime</div></pre></td></tr></table></figure>
<p>修改屬性解鎖帳號。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dn: uid=user01,ou=user,dc=example,dc=com</div><div class="line">changetype: modify</div><div class="line">delete: <span class="built_in">pwd</span>AccountLockedTime</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://raix852.github.io/2016/11/01/ldap/" data-id="cj29ugzw1000zdlr1tsr06yrn" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LDAP/">LDAP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/">Linux</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Microservices" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/10/23/Microservices/" class="article-date">
  <time datetime="2016-10-22T17:30:00.000Z" itemprop="datePublished">2016-10-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/23/Microservices/">Scalable Microservices with Kubernetes - Lesson 4</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>到目前為止，Kubernetes 就像是 docker 的延伸工具，但是要處理真正的問題時呢？ 像是</p>
<ul>
<li>Persistent Storage</li>
<li>TLS search</li>
<li>Advance deployment</li>
</ul>
<p>這時，需要的是確保 applications 處於 <strong>Desired State</strong> 。</p>
<h2 id="Deployments"><a href="#Deployments" class="headerlink" title="Deployments"></a>Deployments</h2><p>Drive current state towards desired state.</p>
<p>Kubernetes 使用 replica set 設定 pod 要啟動幾個，並將 pod 要啟動在哪邊，啟動幾個抽離出來，由 Kubernetes 自動管理。<br>以下圖為例，當設定 replica 為 1 時，啟動在 node 1 。</p>
<p><img src="http://i.imgur.com/lVnxqRf.jpg" alt="replica 1"></p>
<p>當 replica 變為 3 時，自動部署到三個 node 上，每個 node 啟動一個。</p>
<p><img src="http://i.imgur.com/fDEfyoQ.jpg" alt="replica 3"></p>
<p>當 node 3 掛掉時，自動挑選一個 node ，在上面重新啟動一個。</p>
<p><img src="http://i.imgur.com/QrGQ0KL.jpg" alt="replica 3 when 1 node down"></p>
<h3 id="Create-Deployments"><a href="#Create-Deployments" class="headerlink" title="Create Deployments"></a>Create Deployments</h3><p>接下來要部署三個 services: <strong>frontend</strong>, <strong>auth</strong>, <strong>hello</strong> 。<br>auth 和 hello 屬於 internal services，frontend 屬於 external services。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">$ cat deployments/auth.yaml</div><div class="line">apiVersion: extensions/v1beta1</div><div class="line">kind: Deployment</div><div class="line">metadata:</div><div class="line">  name: auth</div><div class="line">spec:</div><div class="line">  replicas: 1</div><div class="line">  template:</div><div class="line">    metadata:</div><div class="line">      labels:</div><div class="line">        app: auth</div><div class="line">        track: stable</div><div class="line">    spec:</div><div class="line">      containers:</div><div class="line">        - name: auth</div><div class="line">          image: <span class="string">"udacity/example-auth:1.0.0"</span></div><div class="line">...</div></pre></td></tr></table></figure>
<p>觀看 <code>auth.yaml</code> 設定，<code>replicas: 1</code> 表示啟動一個，改變數量可以改變啟動的個數，<code>labels:</code> 標示 key:value 標籤，<code>image: &quot;udacity/example-auth:1.0.0&quot;</code> 標示使用的 container 和版本。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">$ kubectl create <span class="_">-f</span> deployments/auth.yaml</div><div class="line">deployment <span class="string">"auth"</span> created</div><div class="line"></div><div class="line">$ kubectl get deployment</div><div class="line">NAME      DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</div><div class="line">auth      1         1         1            1           1m</div><div class="line"></div><div class="line">$ kubectl describe deployment auth</div><div class="line">Name:			auth</div><div class="line">Namespace:		default</div><div class="line">CreationTimestamp:	Sat, 22 Oct 2016 20:52:36 +0800</div><div class="line">Labels:			app=auth</div><div class="line">			track=stable</div><div class="line">Selector:		app=auth,track=stable</div><div class="line">Replicas:		1 updated | 1 total | 1 available | 0 unavailable</div><div class="line">StrategyType:		RollingUpdate</div><div class="line">M<span class="keyword">in</span>ReadySeconds:	0</div><div class="line">RollingUpdateStrategy:	1 max unavailable, 1 max surge</div><div class="line">OldReplicaSets:		&lt;none&gt;</div><div class="line">NewReplicaSet:		auth-2330758036 (1/1 replicas created)</div><div class="line">Events:</div><div class="line">  FirstSeen	LastSeen	Count	From				SubobjectPath	Type		Reason			Message</div><div class="line">  ---------	--------	-----	----				-------------	--------	------			-------</div><div class="line">  2m		2m		1	&#123;deployment-controller &#125;			Normal		ScalingReplicaSet	Scaled up replica <span class="built_in">set</span> auth-2330758036 to 1</div><div class="line"></div><div class="line">$ kubectl create <span class="_">-f</span> services/auth.yaml</div><div class="line">service <span class="string">"auth"</span> created</div></pre></td></tr></table></figure>
<p>一樣透過 <code>kubectl create -f deployments/auth.yaml</code> 將 <code>auth</code> 建立出來，使用 <code>kubectl describe deployment auth</code> 查看詳細資訊，利用 <code>kubectl create -f services/auth.yaml</code> 建立 service。<br>接著透過相同的手法將 frontend 和 hello 建出。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ kubectl create <span class="_">-f</span> deployments/hello.yaml</div><div class="line">$ kubectl create <span class="_">-f</span> services/hello.yaml</div><div class="line">$ kubectl create <span class="_">-f</span> deployments/frontend.yaml</div><div class="line">$ kubectl create <span class="_">-f</span> services/frontend.yaml</div></pre></td></tr></table></figure>
<p>這邊會因為 <code>frontend.yaml</code> 裡定義的 configmap 還沒有建立，導致 pod 要 mount configmap 時失敗而處於 <strong>ContainerCreating</strong> 狀態，但是不用擔心，馬上補做建立 configmap 動作。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ kubectl create configmap nginx-frontend-conf --from-file=nginx/frontend.conf</div><div class="line">configmap <span class="string">"nginx-frontend-conf"</span> created</div></pre></td></tr></table></figure>
<p>接著觀察 pod 狀態，過一段時間就會自動發現可以 mount 了，將 pod 成功運行。<br>另外由於我是使用自己的 Ubuntu server ，因此需要手動指派 external IP ，修改 <code>kubectl create -f services/frontend.yaml</code> 加入 <code>externalIPs&quot; : [&quot;192.168.1.1&quot;]</code> 一行指定使用 local IP ，這樣可以透過 external IP 連線進 pods。</p>
<h2 id="Scaling"><a href="#Scaling" class="headerlink" title="Scaling"></a>Scaling</h2><p>改變 deployment 設定檔裡的 replica 數量，透過 <code>kubectl apply</code> 將設定檔生效，讓 kubernetes 去處理 pod creation, deletion and update 。</p>
<h3 id="Show-replica"><a href="#Show-replica" class="headerlink" title="Show replica"></a>Show replica</h3><p>檢查目前 pods 的 replica 數量，可發現目前 pods 數量只有 1。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$ kubectl get replicasets</div><div class="line">NAME                  DESIRED   CURRENT   READY     AGE</div><div class="line">auth-2330758036       1         1         1         3h</div><div class="line">frontend-1629713508   1         1         1         2h</div><div class="line">hello-396922042       1         1         1         2h</div><div class="line">$ kubectl get pods <span class="_">-l</span> <span class="string">"app=hello,track=stable"</span></div><div class="line">NAME                    READY     STATUS    RESTARTS   AGE</div><div class="line">hello-396922042-lld6j   1/1       Running   0          2h</div></pre></td></tr></table></figure>
<p>修改 <code>deployments/hello.yaml</code> ，將 replicas 變為 3，透過 <code>kubectl apply</code> 將設定檔生效。<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ vim deployments/hello.yaml</div><div class="line"><span class="comment"># Change replicas: 3</span></div><div class="line">$ kubectl apply <span class="_">-f</span> deployments/hello.yaml</div><div class="line"><span class="comment"># Apply change</span></div></pre></td></tr></table></figure></p>
<p>檢查 pod 數量是否符合設定，可發現目前 pods 數量變成 3。<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">$ kubectl get replicasets</div><div class="line">NAME                  DESIRED   CURRENT   READY     AGE</div><div class="line">auth-2330758036       1         1         1         3h</div><div class="line">frontend-1629713508   1         1         1         2h</div><div class="line">hello-396922042       3         3         3         2h</div><div class="line"></div><div class="line">$ kubectl get pods</div><div class="line">NAME                        READY     STATUS    RESTARTS   AGE</div><div class="line">auth-2330758036-t2x54       1/1       Running   0          3h</div><div class="line">frontend-1629713508-w1r0u   1/1       Running   0          2h</div><div class="line">hello-396922042-69h7w       1/1       Running   0          1m</div><div class="line">hello-396922042-lld6j       1/1       Running   0          2h</div><div class="line">hello-396922042-mxjk5       1/1       Running   0          1m</div><div class="line"></div><div class="line">$ kubectl describe deployment hello</div><div class="line">Name:			hello</div><div class="line">Namespace:		default</div><div class="line">CreationTimestamp:	Sat, 22 Oct 2016 21:08:56 +0800</div><div class="line">Labels:			app=hello</div><div class="line">			track=stable</div><div class="line">Selector:		app=hello,track=stable</div><div class="line">Replicas:		3 updated | 3 total | 3 available | 0 unavailable</div><div class="line">StrategyType:		RollingUpdate</div><div class="line">M<span class="keyword">in</span>ReadySeconds:	0</div><div class="line">RollingUpdateStrategy:	1 max unavailable, 1 max surge</div><div class="line">OldReplicaSets:		&lt;none&gt;</div><div class="line">NewReplicaSet:		hello-396922042 (3/3 replicas created)</div><div class="line">Events:</div><div class="line">  FirstSeen	LastSeen	Count	From				SubobjectPath	Type		Reason			Message</div><div class="line">  ---------	--------	-----	----				-------------	--------	------			-------</div><div class="line">  2m		2m		1	&#123;deployment-controller &#125;			Normal		ScalingReplicaSet	Scaled up replica <span class="built_in">set</span> hello-396922042 to 3</div></pre></td></tr></table></figure></p>
<h2 id="Rolling-Update"><a href="#Rolling-Update" class="headerlink" title="Rolling Update"></a>Rolling Update</h2><p>當 pods 設定修改後，需要做 update 時，一次將所有 pods 更新是件很危險的事。因此 Kubernetes 提供 rolling update 機制讓 pods 逐漸更新。</p>
<p>以下圖為例，更新之前。</p>
<p><img src="http://i.imgur.com/TkMk324.jpg" alt="Before"></p>
<p>更新過程中，會先在其中一個 node 上啟動新的 pod ，等新的 pod 啟動完畢可以接手工作之後，舊的 pod 首先會失去連結，然後關閉。</p>
<p><img src="http://i.imgur.com/7MJobXM.jpg" alt="Updating"></p>
<p>接著在每個 node 上重複上述的過程，最後的結果如下圖所示，所有 node 上的 pods 都更新到新版。</p>
<p><img src="http://i.imgur.com/656Hc0R.jpg" alt="Complete"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://raix852.github.io/2016/10/23/Microservices/" data-id="cj29ugzvz000xdlr1w4y1hk3o" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Kubernetes/">Kubernetes</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Udacity/">Udacity</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/">docker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/學習筆記/">學習筆記</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Microservices" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/10/22/Microservices/" class="article-date">
  <time datetime="2016-10-22T08:30:00.000Z" itemprop="datePublished">2016-10-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/22/Microservices/">Scalable Microservices with Kubernetes - Lesson 3</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>第三堂課介紹 Kubernetes。</p>
<p><strong>Conway’s Law</strong><br><br>Organizations which design systems … are constrained to produce designs which are copies of the communication structures of these organizations</p>
<h2 id="What-is-Kubernetes"><a href="#What-is-Kubernetes" class="headerlink" title="What is Kubernetes?"></a>What is Kubernetes?</h2><p>將程式包成 container 只解決了 5% 的問題。真實的問題是</p>
<ul>
<li><strong>App Configuration</strong></li>
<li><strong>Service Discovery</strong></li>
<li><strong>Managing Updates</strong></li>
<li><strong>Monitoring</strong></li>
</ul>
<p>Kubernetes 提供了新一層 abstractions 來包覆 deployment，讓使用者可以專注於大局。<br>Kubernetes 可以讓我們將每台機器抽象起來，讓操作 cluster 起來就像邏輯上操作一台機器一樣。<br>在 Kubernetes 裡，描述一串 applications ，設定如何互動，並使之發生。</p>
<h2 id="Setting-up-Kubernetes-for-this-course"><a href="#Setting-up-Kubernetes-for-this-course" class="headerlink" title="Setting up Kubernetes for this course"></a>Setting up Kubernetes for this course</h2><p>課程上是使用 Google Cloud Platform(GCP)，而我是準備一台 Ubuntu server ，上面安裝好 Kubernetes 來進行這個課程。<br><br><a href="https://github.com/udacity/ud615" target="_blank" rel="external">Course Repo</a></p>
<h2 id="Get-started"><a href="#Get-started" class="headerlink" title="Get started"></a>Get started</h2><h3 id="Launch-a-single-instance"><a href="#Launch-a-single-instance" class="headerlink" title="Launch a single instance"></a>Launch a single instance</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ kubectl run nginx --image=nginx:1.10.0</div></pre></td></tr></table></figure>
<p>將 nginx container 透過 kubectl 指令啟動</p>
<h3 id="Get-pods"><a href="#Get-pods" class="headerlink" title="Get pods"></a>Get pods</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ kubectl get pods</div></pre></td></tr></table></figure>
<p>在 Kubernetes 裡，所有的 Containers 運行在 pod ，使用上述指令列出正在運行的 pods</p>
<h3 id="Expose-nginx"><a href="#Expose-nginx" class="headerlink" title="Expose nginx"></a>Expose nginx</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ kubectl expose deployment nginx --port 80 --type LoadBalancer</div></pre></td></tr></table></figure>
<p>上面指令會建立出 load balancer 且派發一個 public IP 在上面，並將 80 port 暴露給外面。任何一個 Client 透過派發的 IP 連線將會經過 load balancer 傳送到內部 container，在這邊的例子是 nginx 。</p>
<h3 id="List-services"><a href="#List-services" class="headerlink" title="List services"></a>List services</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ kubectl get services</div></pre></td></tr></table></figure>
<p>列出 services 資訊，像是 Public IP, expose port 。</p>
<h2 id="Pods"><a href="#Pods" class="headerlink" title="Pods"></a>Pods</h2><p>Kubernetes 的核心是 Pods ，Pods 代表的是 Logical Application 。<br></p>
<ul>
<li><strong>One or more containers</strong> - 將具有依賴關係的 containers 包在同一個 pod 裡。</li>
<li><strong>Volumes</strong> - containers 放置資料的地方，可以被所有在 pod 裡的 containers 使用</li>
<li><strong>Shared namespace</strong> - Shared namespace 表示在相同 pod 裡的 containers 互相溝通，並分享相同的 Volumes</li>
<li><strong>One IP per pod</strong> - 在同一個 pod 裡的 containers 共享相同的 public IP 。</li>
</ul>
<h3 id="Pods-Configuration"><a href="#Pods-Configuration" class="headerlink" title="Pods Configuration"></a>Pods Configuration</h3><p>在 Kubernetes 裡，建立 pods 是透過設定 yaml 格式的設定檔。如下 <code>monolith.yaml</code>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">$ cat pods/monolith.yaml</div><div class="line">apiVersion: v1</div><div class="line">kind: Pod</div><div class="line">metadata:</div><div class="line">  name: monolith</div><div class="line">  labels:</div><div class="line">    app: monolith</div><div class="line">spec:</div><div class="line">  containers:</div><div class="line">    - name: monolith</div><div class="line">      image: udacity/example-monolith:1.0.0</div><div class="line">      args:</div><div class="line">        - <span class="string">"-http=0.0.0.0:80"</span></div><div class="line">        - <span class="string">"-health=0.0.0.0:81"</span></div><div class="line">        - <span class="string">"-secret=secret"</span></div><div class="line">      ports:</div><div class="line">        - name: http</div><div class="line">          containerPort: 80</div><div class="line">        - name: health</div><div class="line">          containerPort: 81</div><div class="line">      resources:</div><div class="line">        limits:</div><div class="line">          cpu: 0.2</div><div class="line">          memory: <span class="string">"10Mi"</span></div></pre></td></tr></table></figure>
<p>在 <code>contains:</code> 底下標示 container 的屬性。包含</p>
<ul>
<li><code>name:</code> : container 名稱</li>
<li><code>image:</code> : 要使用的 container image</li>
<li><code>args:</code> Application 執行時所需的參數</li>
<li><code>port:</code> : 需要暴露給外面的 ports</li>
<li><code>resources:</code> : 限制 cpu 和記憶體使用量。</li>
</ul>
<h3 id="Create-the-pod"><a href="#Create-the-pod" class="headerlink" title="Create the pod"></a>Create the pod</h3><p>將設定好的 <code>monolith.yaml</code> 透過底下指令將 monolith pod 建立出來。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ kubectl create <span class="_">-f</span> pods/monolith.yaml</div><div class="line">pod <span class="string">"monolith"</span> created</div></pre></td></tr></table></figure>
<h3 id="Examine-pods"><a href="#Examine-pods" class="headerlink" title="Examine pods"></a>Examine pods</h3><p>在 pod 剛建立出來時需要準備一段時間讓 container 啟動。透過以下指令觀察是否建立出來以及正在運行。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ kubectl get pods</div><div class="line">NAME       READY     STATUS    RESTARTS   AGE</div><div class="line">monolith   1/1       Running   0          14s</div></pre></td></tr></table></figure>
<h3 id="Describe-pods"><a href="#Describe-pods" class="headerlink" title="Describe pods"></a>Describe pods</h3><p>需要檢查詳細的資訊可以透過以下指令。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ kubectl describe pods monolith</div></pre></td></tr></table></figure>
<p>會列出 container 被指派的 IP，暴露的 port ，以及其他許多的 metadata 和發生的 events log。</p>
<h3 id="Port-forward"><a href="#Port-forward" class="headerlink" title="Port forward"></a>Port forward</h3><p>設定一個或多個 local port 轉送到 pod 裡的 port。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ kubectl port-forward monolith 10080:80</div><div class="line">Forwarding from 127.0.0.1:10080 -&gt; 80</div><div class="line">Forwarding from [::1]:10080 -&gt; 80</div></pre></td></tr></table></figure>
<p>這道指令會處於 listen 狀態，開啟另一個 terminal 測試 monolith 連線。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ curl http://127.0.0.1:10080</div><div class="line">&#123;<span class="string">"message"</span>:<span class="string">"Hello"</span>&#125;</div><div class="line">$ curl http://127.0.0.1:10080/secure</div><div class="line">authorization failed</div></pre></td></tr></table></figure>
<p>測試 login。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ curl -u user http://127.0.0.1:10080/login</div><div class="line">Enter host password <span class="keyword">for</span> user <span class="string">'user'</span>: password</div><div class="line">&#123;<span class="string">"token"</span>:<span class="string">"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InVzZXJAZXhhbXBsZS5jb20iLCJleHAiOjE0NzcxNTA3ODQsImlhdCI6MTQ3Njg5MTU4NCwiaXNzIjoiYXV0aC5zZXJ2aWNlIiwic3ViIjoidXNlciJ9.Rgm5BBG8VSiLH-u26Am1QAaXtz05nzvfWWZhHjOcaus"</span>&#125;</div><div class="line">$ curl -H <span class="string">"Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InVzZXJAZXhhbXBsZS5jb20iLCJleHAiOjE0NzcxNTA3ODQsImlhdCI6MTQ3Njg5MTU4NCwiaXNzIjoiYXV0aC5zZXJ2aWNlIiwic3ViIjoidXNlciJ9.Rgm5BBG8VSiLH-u26Am1QAaXtz05nzvfWWZhHjOcaus"</span> http://127.0.0.1:10080/secure</div><div class="line">&#123;<span class="string">"message"</span>:<span class="string">"Hello"</span>&#125;</div></pre></td></tr></table></figure>
<h3 id="View-logs"><a href="#View-logs" class="headerlink" title="View logs"></a>View logs</h3><p>列出 pod 裡的 container log。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$ kubectl logs monolith</div><div class="line">2016/10/19 15:04:10 Starting server...</div><div class="line">2016/10/19 15:04:10 Health service listening on 0.0.0.0:81</div><div class="line">2016/10/19 15:04:10 HTTP service listening on 0.0.0.0:80</div><div class="line">127.0.0.1:59954 - - [Wed, 19 Oct 2016 15:22:34 UTC] <span class="string">"GET / HTTP/1.1"</span> curl/7.47.0</div><div class="line">127.0.0.1:59986 - - [Wed, 19 Oct 2016 15:22:48 UTC] <span class="string">"GET /secure HTTP/1.1"</span> curl/7.47.0</div><div class="line">127.0.0.1:33138 - - [Wed, 19 Oct 2016 15:38:29 UTC] <span class="string">"GET /login HTTP/1.1"</span> curl/7.47.0</div><div class="line">127.0.0.1:33226 - - [Wed, 19 Oct 2016 15:39:26 UTC] <span class="string">"GET /login HTTP/1.1"</span> curl/7.47.0</div><div class="line">127.0.0.1:33252 - - [Wed, 19 Oct 2016 15:39:43 UTC] <span class="string">"GET /login HTTP/1.1"</span> curl/7.47.0</div><div class="line">127.0.0.1:33430 - - [Wed, 19 Oct 2016 15:41:41 UTC] <span class="string">"GET /secure HTTP/1.1"</span> curl/7.47.0</div><div class="line">127.0.0.1:33492 - - [Wed, 19 Oct 2016 15:42:20 UTC] <span class="string">"GET /secure HTTP/1.1"</span> curl/7.47.0</div></pre></td></tr></table></figure>
<p>加 <code>-f</code> 進入 stream 模式，監控即時 log 。</p>
<h3 id="Enter-container"><a href="#Enter-container" class="headerlink" title="Enter container"></a>Enter container</h3><p>需要像 <code>docker exec</code> 進入 container 執行指令的話，透過底下指令。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ kubectl <span class="built_in">exec</span> monolith --stdin --tty -c monolith /bin/sh</div><div class="line">/ <span class="comment">#</span></div></pre></td></tr></table></figure>
<h2 id="Monitor-and-Health-Checks"><a href="#Monitor-and-Health-Checks" class="headerlink" title="Monitor and Health Checks"></a>Monitor and Health Checks</h2><p>Kubernetes 提供了 Health Checks 機制，讓使用者自訂檢查 applications 健康狀態和 readiness check。<br>Readiness check 用來確認 pod 是否已經準備好可以提供服務，當 check failed 時，container 會被標記成 not ready 並從 load balancer 中移除。<br>Liveness probe 檢查 container 是否活著，如果檢查多次失敗， container 將會重啟。</p>
<h3 id="問題練習"><a href="#問題練習" class="headerlink" title="問題練習"></a>問題練習</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">$ cat pods/monolith.yaml</div><div class="line">...</div><div class="line">  livenessProbe:</div><div class="line">    httpGet:</div><div class="line">      path: /healthz</div><div class="line">      port: 81</div><div class="line">      scheme: HTTP</div><div class="line">    initialDelaySeconds: 5</div><div class="line">    periodSeconds: 15</div><div class="line">    timeoutSeconds: 5</div><div class="line">  readinessProbe:</div><div class="line">    httpGet:</div><div class="line">      path: /readiness</div><div class="line">      port: 81</div><div class="line">      scheme: HTTP</div><div class="line">    initialDelaySeconds: 5</div><div class="line">    timeoutSeconds: 1</div><div class="line"></div><div class="line"></div><div class="line">$ kubectl create <span class="_">-f</span> pods/monolith.yaml</div><div class="line">pod <span class="string">"healthy-monolith"</span> created</div><div class="line"></div><div class="line">$ kubectl describe pods healthy-monolith</div><div class="line">...</div><div class="line">  State:		Running</div><div class="line">    Started:		Fri, 21 Oct 2016 22:37:12 +0800</div><div class="line">  Ready:		True</div><div class="line">  Restart Count:	0</div><div class="line">  Liveness:		http-get http://:81/healthz delay=5s timeout=5s period=15s <span class="comment">#success=1 #failure=3</span></div><div class="line">  Readiness:		http-get http://:81/readiness delay=5s timeout=1s period=10s <span class="comment">#success=1 #failure=3</span></div><div class="line">...</div></pre></td></tr></table></figure>
<p>使用 healthy-monolith pod，回答下面三個問題。</p>
<ul>
<li><p>How is the readiness probe performed?</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">readinessProbe:</div><div class="line">  httpGet:</div><div class="line">    path: /readiness</div><div class="line">    port: 81</div><div class="line">    scheme: HTTP</div><div class="line">  initialDelaySeconds: 5</div><div class="line">  timeoutSeconds: 1</div></pre></td></tr></table></figure>
</li>
<li><p>How often is the readiness checked?<br><code>period=10s</code></p>
</li>
<li>How often is the liveness probe checked?<br><code>period=15s</code></li>
</ul>
<h2 id="Secret-and-ConfigMap"><a href="#Secret-and-ConfigMap" class="headerlink" title="Secret and ConfigMap"></a>Secret and ConfigMap</h2><p>ConfigMap 和 Secret 相似，但是 ConfigMap 用來存放較不敏感的資料，而像密碼或金鑰之類的需要安全性的資料則使用 Secret。 Secret 會在 pod 建立時， mount 到 container 裡當作 volume，讓 container 擁有和使用。</p>
<p><a href="http://kubernetes.io/docs/user-guide/configmap/" target="_blank" rel="external">ConfigMap</a><br><a href="http://kubernetes.io/docs/user-guide/secrets/" target="_blank" rel="external">Secrets</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Create secret</span></div><div class="line">$ kubectl create secret generic tls-certs --from-file=tls/</div><div class="line"><span class="comment"># Use secure-monolith pod</span></div><div class="line">$ kubectl create <span class="_">-f</span> pods/secure-monolith.yaml</div></pre></td></tr></table></figure>
<p>以下使用 nginx reverse proxy 為例子，將 https(443 port) 連線轉送到 http(80 port)。</p>
<h3 id="Create-secret"><a href="#Create-secret" class="headerlink" title="Create secret"></a>Create secret</h3><p>https 連線需要 Certificate ，使用 secret 將 Certificate 封裝起來。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ kubectl create secret generic tls-certs --from-file=tls/</div></pre></td></tr></table></figure>
<h3 id="Describe-secret"><a href="#Describe-secret" class="headerlink" title="Describe secret"></a>Describe secret</h3><p>kubectl will create a key for each file in the tls directory under the tls-certs secret bucket. Use the <code>kubectl describe</code> command to verify that:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ kubectl describe secrets tls-certs</div></pre></td></tr></table></figure>
<h3 id="Create-ConfigMap"><a href="#Create-ConfigMap" class="headerlink" title="Create ConfigMap"></a>Create ConfigMap</h3><p>將 nginx reverse proxy 的設定透過 ConfigMap 封裝起來。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ kubectl create configmap nginx-proxy-conf --from-file=nginx/proxy.conf</div></pre></td></tr></table></figure>
<h3 id="Describe-ConfigMap"><a href="#Describe-ConfigMap" class="headerlink" title="Describe ConfigMap"></a>Describe ConfigMap</h3><p>透過 <code>kubectl describe configmap</code> 獲得詳細的資訊。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ kubectl describe configmap nginx-proxy-conf</div></pre></td></tr></table></figure>
<h3 id="操作練習"><a href="#操作練習" class="headerlink" title="操作練習"></a>操作練習</h3><p>使用 secure-monolith pod 作為這次練習。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line">$ cat pods/secure-monolith.yaml</div><div class="line"></div><div class="line">apiVersion: v1</div><div class="line">kind: Pod</div><div class="line">metadata:</div><div class="line">  name: <span class="string">"secure-monolith"</span></div><div class="line">  labels:</div><div class="line">    app: monolith</div><div class="line">spec:</div><div class="line">  containers:</div><div class="line">    - name: nginx</div><div class="line">      image: <span class="string">"nginx:1.9.14"</span></div><div class="line">      lifecycle:</div><div class="line">        preStop:</div><div class="line">          <span class="built_in">exec</span>:</div><div class="line">            <span class="built_in">command</span>: [<span class="string">"/usr/sbin/nginx"</span>,<span class="string">"-s"</span>,<span class="string">"quit"</span>]</div><div class="line">      volumeMounts:</div><div class="line">        - name: <span class="string">"nginx-proxy-conf"</span></div><div class="line">          mountPath: <span class="string">"/etc/nginx/conf.d"</span></div><div class="line">        - name: <span class="string">"tls-certs"</span></div><div class="line">          mountPath: <span class="string">"/etc/tls"</span></div><div class="line">    - name: monolith</div><div class="line">      image: <span class="string">"udacity/example-monolith:1.0.0"</span></div><div class="line">      ports:</div><div class="line">        - name: http</div><div class="line">          containerPort: 80</div><div class="line">        - name: health</div><div class="line">          containerPort: 81</div><div class="line">      resources:</div><div class="line">        limits:</div><div class="line">          cpu: 0.2</div><div class="line">          memory: <span class="string">"10Mi"</span></div><div class="line">      livenessProbe:</div><div class="line">        httpGet:</div><div class="line">          path: /healthz</div><div class="line">          port: 81</div><div class="line">          scheme: HTTP</div><div class="line">        initialDelaySeconds: 5</div><div class="line">        periodSeconds: 15</div><div class="line">        timeoutSeconds: 5</div><div class="line">      readinessProbe:</div><div class="line">        httpGet:</div><div class="line">          path: /readiness</div><div class="line">          port: 81</div><div class="line">          scheme: HTTP</div><div class="line">        initialDelaySeconds: 5</div><div class="line">        timeoutSeconds: 1</div><div class="line">  volumes:</div><div class="line">    - name: <span class="string">"tls-certs"</span></div><div class="line">      secret:</div><div class="line">        secretName: <span class="string">"tls-certs"</span></div><div class="line">    - name: <span class="string">"nginx-proxy-conf"</span></div><div class="line">      configMap:</div><div class="line">        name: <span class="string">"nginx-proxy-conf"</span></div><div class="line">        items:</div><div class="line">          - key: <span class="string">"proxy.conf"</span></div><div class="line">            path: <span class="string">"proxy.conf"</span></div></pre></td></tr></table></figure>
<p>在 secure-monolith pod 設定裡，可以看到使用兩個 container ，分別為 nginx 和 monolith ， nginx 會作為 reverse proxy 將連線導入 monolith 。</p>
<p>在 nginx 設定裡，有設定 <code>lifecycle</code> 當 nginx container 要關閉時，先執行所設定的 command ，清理剩餘的工作。在 <code>volumeMounts</code> 裡，設定先前建立的 secret 和 ConfigMap ，將之 mount。</p>
<h3 id="Create-secure-monolith-pod"><a href="#Create-secure-monolith-pod" class="headerlink" title="Create secure-monolith pod"></a>Create secure-monolith pod</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Create the secure-monolith Pod using kubectl.</div><div class="line"></div><div class="line">kubectl create <span class="_">-f</span> pods/secure-monolith.yaml</div><div class="line">kubectl get pods secure-monolith</div></pre></td></tr></table></figure>
<h3 id="Check-connection"><a href="#Check-connection" class="headerlink" title="Check connection"></a>Check connection</h3><p>使用先前學過的 port-forward 指令，將 local 10443 port 開通到 nginx 443 port ，測試 TLS 連線能不能相通。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">kubectl port-forward secure-monolith 10443:443</div><div class="line"></div><div class="line">curl --cacert tls/ca.pem https://127.0.0.1:10443</div><div class="line"></div><div class="line">kubectl logs -c nginx secure-monolith</div></pre></td></tr></table></figure>
<h2 id="Services"><a href="#Services" class="headerlink" title="Services"></a>Services</h2><p>不管是使用 pod 還是 docker container ，都會遇到一個問題是，container 會因各種原因需要進行重啟，而重啟時 IP 會重新指派，因此無法仰賴固定的 IP 。因此 Kubernetes 引入 Services 當作 pod 的 abstraction ，由 Services 當作是 pods 前端，提供穩定的連接，因此後端的 pods 的更動，就不會影響整體。</p>
<p>Persistent Endpoint for Pods<br></p>
<ul>
<li>Use labels to select pods</li>
<li>Internal or External IP</li>
</ul>
<h3 id="Create-Services"><a href="#Create-Services" class="headerlink" title="Create Services"></a>Create Services</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">$ cat services/monolith.yaml</div><div class="line">kind: Service</div><div class="line">apiVersion: v1</div><div class="line">metadata:</div><div class="line">  name: <span class="string">"monolith"</span></div><div class="line">spec:</div><div class="line">  selector:</div><div class="line">    app: <span class="string">"monolith"</span></div><div class="line">    secure: <span class="string">"enabled"</span></div><div class="line">  ports:</div><div class="line">    - protocol: <span class="string">"TCP"</span></div><div class="line">      port: 443</div><div class="line">      targetPort: 443</div><div class="line">      nodePort: 31000</div><div class="line">  <span class="built_in">type</span>: NodePort</div></pre></td></tr></table></figure>
<p>Services 設定裡透過 <code>selector</code> 將有符合 label 的 pods 選出來聚在一起。並把所有 pods 443 port 暴露出來，讓 local 31000 port 轉到 pods 443 port。</p>
<p>接著建立 services 。<br><br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ kubectl create <span class="_">-f</span> services/monolith.yaml</div></pre></td></tr></table></figure></p>
<p>這時 services 沒有選擇到任何東西 ，因為沒有一個 pod 的 label 符合，可以透過以下指令檢查。<br><br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ kubectl get pods <span class="_">-l</span> <span class="string">"app=monolith,secure=enabled"</span></div></pre></td></tr></table></figure></p>
<p>將 secure-monolith pod 加入 label。 <br><br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ kubectl label pods secure-monolith <span class="string">"secure=enabled"</span></div><div class="line">$ kubectl get pods <span class="_">-l</span> <span class="string">"app=monolith,secure=enabled"</span></div><div class="line">NAME              READY     STATUS    RESTARTS   AGE</div><div class="line">secure-monolith   2/2       Running   0          5h</div></pre></td></tr></table></figure></p>
<p>此時 services 就可以接管 secure-monolith pod 。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://raix852.github.io/2016/10/22/Microservices/" data-id="cj29ugzvx000vdlr13zf250ui" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Kubernetes/">Kubernetes</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Udacity/">Udacity</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/">docker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/學習筆記/">學習筆記</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Microservices" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/10/12/Microservices/" class="article-date">
  <time datetime="2016-10-12T15:00:00.000Z" itemprop="datePublished">2016-10-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/12/Microservices/">Scalable Microservices with Kubernetes - Lesson 2</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>第二節課在教 docker 觀念以及如何使用，內容對初心者而言非常簡易上手，對我來說也可當作複習的機會。</p>
<h2 id="Why-docker"><a href="#Why-docker" class="headerlink" title="Why docker?"></a>Why docker?</h2><p>docker 所使用的 image 不只包含程式本身，所需要的 dependencies 和執行時所需的設定檔也都包含在內。docker 本身也提供良好的 API</p>
<ul>
<li><strong>create</strong></li>
<li><strong>distribute</strong></li>
<li><strong>run</strong></li>
</ul>
<p>container 在 server 上。目前支援的 OS 平台有 linux 和 windows。</p>
<p>docker 可以幫助系統管理者作到</p>
<ul>
<li><strong>Reproducable</strong></li>
<li><strong>Consistant</strong></li>
</ul>
<p>docker 可以提供類似 virtual machine 的功能，將執行程式從同一台機器上隔離出來，因此可不用擔心各種 dependencies 問題。</p>
<h2 id="docker-擅長什麼？"><a href="#docker-擅長什麼？" class="headerlink" title="docker 擅長什麼？"></a>docker 擅長什麼？</h2><p>常見的 linux 發布版(Ex. Ubuntu, Redhat) ，擅長於</p>
<ul>
<li><strong>Installing Services</strong></li>
<li><strong>Start and Stop Services</strong></li>
</ul>
<p>docker 在這之上，提供了</p>
<ul>
<li><strong>Installing Services</strong></li>
<li><strong>Start and Stop Services</strong></li>
<li><strong>Running multiple versions</strong></li>
<li><strong>Running multiple instances</strong></li>
</ul>
<p>舉例，要使用 nginx 套件， linux 的套件管理程式可以方便下載，並透過 systemd 或舊的 init.d 將 nginx 啟動。但假設需要在同一台機器上啟動多個 nginx 服務或使用不同的版本，此時就會遇到瓶頸，因為同一時間只能跑一個。而 docker 則可以提供運行多個 instances 和多個版本的能力。</p>
<h2 id="Containers"><a href="#Containers" class="headerlink" title="Containers"></a>Containers</h2><p>可以讓 applications 方便運行和發布到不同平台上的技術。</p>
<ul>
<li><strong>Independent packages</strong> - 將所需要的 dependencies 打包起來，發布到各種平台上。</li>
<li><strong>Namespace isolation</strong> - 提供 filesystem 的 Iiolation 和 network isolatation，讓檔案名稱或 ip/port 不會衝突。</li>
</ul>
<p>與一般的 virtual machine 透過模擬整個 OS 層不同， container 是經由 linux kernel 由邏輯上分割出來，透過 Namespace 隔離和 cgroup 控制 resources 達成，因此可視為輕量級的 VM ，啟動和關閉都非常快速。</p>
<h2 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h2><p>docker 用來建立 image 的檔案，裡面描述指令讓 docker 依指示要從哪個 base image 開始，逐漸將所需要的 dependencies 打包起來，最後完成一個包含所有套件和設定的 application image 來使用。</p>
<p>以下是之前做過得小型 java 7 image，使用 centos 7.2 作為程式運行的環境。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">FROM centos:7.2.1511</div><div class="line">MAINTAINER raix</div><div class="line"></div><div class="line">USER root</div><div class="line">RUN yum install -y wget \</div><div class="line">                git \</div><div class="line">                curl \</div><div class="line">                zip \</div><div class="line">                openssh-clients \</div><div class="line">                java-1.7.0-openjdk \</div><div class="line">                java-1.7.0-openjdk-devel \</div><div class="line">                java-1.7.0-openjdk-headless</div><div class="line"></div><div class="line">ENV LANG C.UTF-8</div></pre></td></tr></table></figure></p>
<h2 id="Docker-Hub"><a href="#Docker-Hub" class="headerlink" title="Docker Hub"></a>Docker Hub</h2><p>做出來的 image 可以發布到 docker hub 上，公開讓所有人使用，直接從 docker hub 上下載完整的 image 下來，而不用從頭建置起來，方便用來做大量佈署的動作。除了 docker hub 這個公開存放 image 的地方，也有其他公開的服務可以使用，像是 gcr (Google Container Registry) ，或是建立私有 hub ，供企業內部使用。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://raix852.github.io/2016/10/12/Microservices/" data-id="cj29ugzvf000kdlr18p035vkb" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Kubernetes/">Kubernetes</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Udacity/">Udacity</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/">docker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/學習筆記/">學習筆記</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Microservices" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/10/11/Microservices/" class="article-date">
  <time datetime="2016-10-11T15:00:00.000Z" itemprop="datePublished">2016-10-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/11/Microservices/">Scalable Microservices with Kubernetes - Lesson 1</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>這門課介紹使用 docker 、 Kubernetes  ，並且會使用 Go 和 Google cloud platform 來學習建立 Microservices 。<br>課程網址：<a href="https://classroom.udacity.com/courses/ud615/" target="_blank" rel="external">Scalable Microservices with Kubernetes</a></p>
<h2 id="什麼是-Microservices？"><a href="#什麼是-Microservices？" class="headerlink" title="什麼是 Microservices？"></a>什麼是 Microservices？</h2><ul>
<li><strong>Moduler</strong></li>
<li><strong>Easy to deploy</strong></li>
<li><strong>Scale independently</strong></li>
</ul>
<p>Microservices 設計模式可以套用在很多地方，像是 Web service。幫助快速開發和 Continuous delivery ，並將測試工具和 infrastructure 設計推上更上一層樓。</p>
<h2 id="Twelve-Factor-App"><a href="#Twelve-Factor-App" class="headerlink" title="Twelve-Factor App"></a>Twelve-Factor App</h2><p>Heroku 在 2012 年提出的 <a href="https://12factor.net/" target="_blank" rel="external">The TWELVE-FACTS APP</a>，在『建構微服務』一書中也有提到這 12 條準則。</p>
<ol>
<li><strong>Codebase</strong> - One codebase tracked in revision control, many deploys</li>
<li><strong>Dependencies</strong> - Explicitly declare and isolate dependencies</li>
<li><strong>Config</strong> - Store config in the environment</li>
<li><strong>Backing services</strong> - Treat backing services as attached resources</li>
<li><strong>Build, release, run</strong> - Strictly separate build and run stages</li>
<li><strong>Processes</strong> - Execute the app as one or more stateless processes</li>
<li><strong>Port binding</strong> - Export services via port binding</li>
<li><strong>Concurrency</strong> - Scale out via the process model</li>
<li><strong>Disposability</strong> - Maximize robustness with fast startup and graceful shutdown</li>
<li><strong>Dev/prod parity</strong> - Keep development, staging, and production as similar as possible</li>
<li><strong>Logs</strong> - Treat logs as event streams</li>
<li><strong>Admin processes</strong> - Run admin/management tasks as one-off processes</li>
</ol>
<p>Twelve-Factor App 可歸類成下列三個重要因素：</p>
<ul>
<li><strong>Portability</strong> - 消除執行環境的不同，像是 dependencies 和 configuration</li>
<li><strong>Deployability</strong> - 可持續佈署在不同環境，或是不同的雲服務商(AWS, GCP)</li>
<li><strong>Scalability</strong> - 根據使用者需求擴充服務能力。</li>
</ul>
<h2 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a>JWT</h2><p>JSON Web Token，用來做：</p>
<ul>
<li><strong>Authentication</strong> - 可被使用者簽證</li>
<li><strong>Information Exchange</strong> - 可打包訊息</li>
</ul>
<p>JWT 可被眾多語言支援 encode / decode ，常用於 Authentication 。</p>
<h2 id="How-does-JWT-work"><a href="#How-does-JWT-work" class="headerlink" title="How does JWT work?"></a>How does JWT work?</h2><ol>
<li>Client 端傳送使用者帳號和密碼到 Server 上</li>
<li>Server 驗證完使用者之後，建立 JWT Token</li>
<li>傳送 JWT Token 到 Client 端，由 Client 端保存</li>
<li>Client 端傳送 request ，並附上 JWT Token</li>
<li>Server 端驗證 JWT Token 是否正確</li>
<li>驗證成功， Server 端傳回 request 的 response</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://raix852.github.io/2016/10/11/Microservices/" data-id="cj29ugzvd000idlr1uowztvhc" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Kubernetes/">Kubernetes</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Udacity/">Udacity</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/">docker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/學習筆記/">學習筆記</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-read-report" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/09/13/read-report/" class="article-date">
  <time datetime="2016-09-12T17:00:00.000Z" itemprop="datePublished">2016-09-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/09/13/read-report/">台灣史上最有梗的台灣史</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="http://i.imgur.com/tYhUNK1.jpg" alt="台灣史上最有梗的台灣史-封面"></p>
<p>說起 PTT 上的『藏書界的竹野內豐』，有誰不認識呢？偶爾逛逛八卦板，看到這位作者的文章一出現，推文立刻就是推到暴，描述台灣的歷史或者是聊起藏書起來，莫不是又有梗又好笑，而且還可以兼具知識傳播，了解歷史內涵，真是讓人敬仰不已。我媽都說我怎麼跪著看 PTT ！</p>
<p>本書從封面一開始，就呈現出不正經的風格，圖上那個鄭成功，不就是放某位姍姍來遲的莊X大師嗎？翻開第一頁，是先展示過去的歷史文獻圖片，下面加註不正經的講解和吐槽，這之間的反差讓人更容易想像當時的環境，引起共鳴，讀歷史的趣味也因此出來。</p>
<p>書中講述的歷史，從最早的原民歷史開始，到第代的台灣為止，之間經歷的朝代各自歸納成一章。書中出現的歷史人物，除了我們從小在歷史課本中耳熟能詳的人物之外，也多描述了一些小人物，或是和這些歷史人物有關的傳說或軼聞。像是在描述鄭成功，開頭標題就描述『我查證過了，很清楚，鄭成功是型男。』，還有鄭成功雖然在台灣統治上只有短短的六個月，但是台灣各地由北到南都有留下不少鄭成功在當地的事蹟傳說，讓人不禁想到他是多麼賣力在製造傳說阿XD。當然，鄭成功哪有那麼有空走遍全台灣，因此很多都是當地人為和心目中的偶像有連結，製造出來的也說不定，這也顯示了鄭成功的影響力對台灣是多麼地大。</p>
<p>另一位書中提及的歷史人物『王得祿』，這是一般歷史教科書上不會寫上的人物，但是卻是台灣在清朝時代裡擔任過最高的官位。王得祿出身於貧賤人家，從小父母雙亡，和哥哥、嫂子住在一起，傳聞提及嫂子曾看到他的真身是一條蛇，和龍有不少相關，因此認定他必成大器。在當時有海盜作亂，清廷招人入伍，王得祿便加入軍隊，帶上嫂子編織的鞋子，擔任舉軍旗的角色。在和海盜作戰的過程中，一開始是被打敗面臨要撤退的情況，此時王得祿因鞋子掉在前線，舉起軍旗要回去撿，這時軍隊看到軍旗往前衝，就以為是要回攻的訊號，，而海盜也看到軍旗向前，認為援兵已到，自己也慌張起來。結果反而打贏了這場杖，王得祿就因此開始了他的官途。最後過世時，民間也留下不少死亡傳說。</p>
<p>通篇讀完，並不會像吃了撒尿牛丸一樣歷史靈光了很多，每次考試都考一百分。但是結合不少 PTT 上常見的梗，讓人讀起歷史起來非有趣，因此推薦當作是入門的書籍，書中沒有提及但是有列出關鍵字的議題可以作為後續深入的主題。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://raix852.github.io/2016/09/13/read-report/" data-id="cj29ugzv6000fdlr17k76y601" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/讀書心得/">讀書心得</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-tensorflow-gpu-installation" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/08/21/tensorflow-gpu-installation/" class="article-date">
  <time datetime="2016-08-21T14:00:00.000Z" itemprop="datePublished">2016-08-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/21/tensorflow-gpu-installation/">Tensorflow gtx 1060 installation</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>上個禮拜電腦在開機時又開始產生了異常狀況，算一算大概壽命快要到達盡頭了。於是心一狠準備花大錢來組台新的來使用，目標是可以讓 tensorflow 跑 GPU 的版本。原訂目標是直上 gtx 1080 ，後來和朋友討論之後是不需要太衝動買這張，但是又要有一定的效能和記憶體容量，考量了一下價錢，最後選擇了 msi gtx 1060 版本。因此目前新的這一台系統環境如下：</p>
<p><img src="http://i.imgur.com/8jdWJYV.png" alt="System Info"></p>
<h1 id="環境準備"><a href="#環境準備" class="headerlink" title="環境準備"></a>環境準備</h1><h2 id="安裝-nvidia-driver"><a href="#安裝-nvidia-driver" class="headerlink" title="安裝 nvidia driver"></a>安裝 nvidia driver</h2><p>這邊我是參考別人的作法，從 <a href="https://launchpad.net/~graphics-drivers/+archive/ubuntu/ppa" target="_blank" rel="external">“Graphics Drivers Team” team</a> 找 driver 下載，若是直接從 nvidia 官網下載 driver 步驟會比較麻煩，看 github 上的討論也有不少問題。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">sudo add-apt-repository ppa:graphics-drivers/ppa</div><div class="line">sudo apt-get update</div><div class="line">sudo apt-get install nvidia-367</div><div class="line">sudo apt-get install mesa-common-dev</div><div class="line">sudo apt-get install freeglut3-dev</div></pre></td></tr></table></figure>
<p>裝好後，重開機將 driver load 進來。</p>
<h2 id="安裝-dependencies-套件"><a href="#安裝-dependencies-套件" class="headerlink" title="安裝 dependencies 套件"></a>安裝 dependencies 套件</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install libglu1-mesa libxi-dev libxmu-dev libglu1-mesa-dev</div></pre></td></tr></table></figure>
<h2 id="安裝-gcc-amp-g-4-8"><a href="#安裝-gcc-amp-g-4-8" class="headerlink" title="安裝 gcc &amp; g++ 4.8"></a>安裝 gcc &amp; g++ 4.8</h2><p>在裝 CUDA 之前，需要先將 gcc &amp; g++ 準備好，由於 ubuntu 預設是使用 4.5 ，因此需要裝額外的版本。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">sudo add-apt-repository ppa:ubuntu-toolchain-r/<span class="built_in">test</span></div><div class="line">sudo apt-get update</div><div class="line">sudo apt-get install gcc-4.8</div><div class="line">sudo apt-get install g++-4.8</div><div class="line">sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-4.8 50</div><div class="line">sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-4.8 50</div></pre></td></tr></table></figure>
<p><strong>10/11 更新</strong></p>
<p>Ubuntu 16.04 使用的 gcc 版本已經非常的新 (Gcc version 5.4)，會造成 <code>#error -- unsupported GNU version! gcc versions later than 5.3 are not supported!</code> 訊息出現，需要去修改 <code>/usr/local/cuda/include/host_config.h</code> 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">#if __GNUC__ &gt; 5 || (__GNUC__ == 5 &amp;&amp; __GNUC_MINOR__ &gt; 3)</div><div class="line"></div><div class="line">//#error -- unsupported GNU version! gcc versions later than 5.3 are not supported!</div><div class="line"></div><div class="line">#endif /* __GNUC__ &gt; 5 || (__GNUC__ == 5 &amp;&amp; __GNUC_MINOR__ &gt; 1) */</div></pre></td></tr></table></figure>
<h2 id="安裝-CUDA-Toolkit-8-0"><a href="#安裝-CUDA-Toolkit-8-0" class="headerlink" title="安裝 CUDA Toolkit 8.0"></a>安裝 CUDA Toolkit 8.0</h2><p>從 <a href="https://developer.nvidia.com/cuda-release-candidate-download" target="_blank" rel="external">CUDA Toolkit 8.0</a> 裡選擇適合的版本。</p>
<p><img src="http://i.imgur.com/DCAL3eF.png" alt="CUDA Toolkit 8.0"></p>
<p>接下來執行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo bash cuda_8.0.27_linux.run</div></pre></td></tr></table></figure></p>
<p>安裝過程中第一步會詢問是否要安裝 nvidia driver ，這裡就填 <code>n</code> ，避免先前安裝的 driver 被蓋過。</p>
<p>安裝完之後，設定環境變數到 <code>.bashrc</code> 裡：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">export PATH=/usr/local/cuda-8.0/bin$&#123;PATH:+:$&#123;PATH&#125;&#125;</div><div class="line">export LD_LIBRARY_PATH=/usr/local/cuda-8.0/lib64$&#123;LD_LIBRARY_PATH:+:$&#123;LD_LIBRARY_PATH&#125;&#125;</div></pre></td></tr></table></figure>
<p>現在就可以下指令來觀察是否有正確安裝好。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">$ nvidia-smi</div><div class="line">Sun Aug 21 22:54:45 2016       </div><div class="line">+-----------------------------------------------------------------------------+</div><div class="line">| NVIDIA-SMI 367.35                 Driver Version: 367.35                    |</div><div class="line">|-------------------------------+----------------------+----------------------+</div><div class="line">| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |</div><div class="line">| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |</div><div class="line">|===============================+======================+======================|</div><div class="line">|   0  GeForce GTX 106...  Off  | 0000:01:00.0      On |                  N/A |</div><div class="line">|  0%   54C    P0    30W / 200W |    310MiB /  6069MiB |      0%      Default |</div><div class="line">+-------------------------------+----------------------+----------------------+</div><div class="line"></div><div class="line">+-----------------------------------------------------------------------------+</div><div class="line">| Processes:                                                       GPU Memory |</div><div class="line">|  GPU       PID  Type  Process name                               Usage      |</div><div class="line">|=============================================================================|</div><div class="line">|    0      3359    G   /usr/lib/xorg/Xorg                             172MiB |</div><div class="line">|    0      4089    G   cinnamon                                       104MiB |</div><div class="line">|    0      4380    G   /usr/lib/firefox/firefox                         1MiB |</div><div class="line">|    0      4523    G   ...s-passed-by-fd --v8-snapshot-passed-by-fd    31MiB |</div><div class="line">+-----------------------------------------------------------------------------+</div></pre></td></tr></table></figure>
<h2 id="安裝-cuDNN-5-0"><a href="#安裝-cuDNN-5-0" class="headerlink" title="安裝 cuDNN 5.0"></a>安裝 cuDNN 5.0</h2><p><a href="https://developer.nvidia.com/rdp/cudnn-download" target="_blank" rel="external">cuDNN Download</a> 從此處選擇 <code>Download cuDNN v5 (May 27, 2016), for CUDA 8.0 RC</code> 。</p>
<p>解壓縮後放到指定的位置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">tar -zxvf cudnn-8.0-linux-x64-v5.0-ga.tgz</div><div class="line">sudo cp cuda/include/cudnn.h /usr/local/cuda/include/</div><div class="line">sudo cp cuda/lib64/libcudnn* /usr/local/cuda/lib64/</div><div class="line">sudo chmod a+r /usr/local/cuda/include/cudnn.h</div><div class="line">sudo chmod a+r /usr/local/cuda/lib64/libcudnn*</div></pre></td></tr></table></figure>
<h1 id="安裝-Tensorflow-with-GPU"><a href="#安裝-Tensorflow-with-GPU" class="headerlink" title="安裝 Tensorflow with GPU"></a>安裝 Tensorflow with GPU</h1><p>這邊要使用最新版本的原始碼。目前 release 的 <code>r0.10 RC0</code> 有 bug 還沒有修好。</p>
<h2 id="下載原始碼"><a href="#下載原始碼" class="headerlink" title="下載原始碼"></a>下載原始碼</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git clone https://github.com/tensorflow/tensorflow.git</div></pre></td></tr></table></figure>
<h2 id="安裝-dependencies"><a href="#安裝-dependencies" class="headerlink" title="安裝 dependencies"></a>安裝 dependencies</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install openjdk-8-jdk openjdk-8-jdk-headless openjdk-8-jre</div><div class="line">sudo apt-get install python-numpy swig python-dev python-wheel</div><div class="line">sudo apt-get install python-setuptools  python-pip</div><div class="line">sudo apt-get install zlib1g-dev</div></pre></td></tr></table></figure>
<h2 id="安裝-Bazel"><a href="#安裝-Bazel" class="headerlink" title="安裝 Bazel"></a>安裝 Bazel</h2><p>Bazel 是 google 在推的 build 工具，適用於大型專案裡有不同語言和套件整合的需求上。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">wget https://github.com/bazelbuild/bazel/releases/download/0.3.1/bazel-0.3.1-installer-linux-x86_64.sh</div><div class="line">bash bazel-0.3.1-installer-linux-x86_64.sh</div></pre></td></tr></table></figure>
<h2 id="設定-Tensorflow"><a href="#設定-Tensorflow" class="headerlink" title="設定 Tensorflow"></a>設定 Tensorflow</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">$ ./configure</div><div class="line">Please specify the location of python. [Default is /usr/bin/python]:</div><div class="line">Do you wish to build TensorFlow with Google Cloud Platform support? [y/N] N</div><div class="line">No Google Cloud Platform support will be enabled for TensorFlow</div><div class="line">Do you wish to build TensorFlow with GPU support? [y/N] y</div><div class="line">GPU support will be enabled for TensorFlow</div><div class="line">Please specify which gcc nvcc should use as the host compiler. [Default is /usr/bin/gcc]:</div><div class="line">Please specify the Cuda SDK version you want to use, e.g. 7.0. [Leave empty to use system default]:</div><div class="line">Please specify the location where CUDA toolkit is installed. Refer to README.md for more details. [Default is /usr/local/cuda]:</div><div class="line">Please specify the cuDNN version you want to use. [Leave empty to use system default]:</div><div class="line">Please specify the location where cuDNN library is installed. Refer to README.md for more details. [Default is /usr/local/cuda]:</div><div class="line">Please specify a list of comma-separated Cuda compute capabilities you want to build with.</div><div class="line">You can find the compute capability of your device at: https://developer.nvidia.com/cuda-gpus.</div><div class="line">Please note that each additional compute capability significantly increases your build time and binary size.</div><div class="line"></div><div class="line">Setting up Cuda include</div><div class="line">Setting up Cuda lib</div><div class="line">Setting up Cuda bin</div><div class="line">Setting up Cuda nvvm</div><div class="line">Setting up CUPTI include</div><div class="line">Setting up CUPTI lib64</div><div class="line">Configuration finished</div></pre></td></tr></table></figure>
<p>基本上設定要啟用 GPU ，剩下的版本環境使用預設值就好。</p>
<h2 id="修改-Tensorflow"><a href="#修改-Tensorflow" class="headerlink" title="修改 Tensorflow"></a>修改 Tensorflow</h2><p>在設定完之後，接下來是測試是否可以編譯成功。在這邊編譯時會出現 ERROR: … undeclared inclusion(s) in rule … ，這邊翻到 issue 3760 裡有人提到需要修改 Tensorflow 的設定。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vim tensorflow/third_party/gpus/crosstool/CROSSTOOL</div></pre></td></tr></table></figure>
<p>在 65 行那邊加入這一行 cxx_builtin_include_directory: “/usr/local/cuda-8.0/include” ，測試加了之後就可以編譯成功。</p>
<h2 id="Build-Tensorflow-with-GPU"><a href="#Build-Tensorflow-with-GPU" class="headerlink" title="Build Tensorflow with GPU"></a>Build Tensorflow with GPU</h2><p>這裡之後就沒遇到什麼問題， 跟著官網安裝指令走就好。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$ bazel build -c opt --config=cuda //tensorflow/cc:tutorials_example_trainer</div><div class="line"></div><div class="line">$ bazel-bin/tensorflow/cc/tutorials_example_trainer --use_gpu</div><div class="line"># Lots of output. This tutorial iteratively calculates the major eigenvalue of</div><div class="line"># a 2x2 matrix, on GPU. The last few lines look like this.</div><div class="line">000009/000005 lambda = 2.000000 x = [0.894427 -0.447214] y = [1.788854 -0.894427]</div><div class="line">000006/000001 lambda = 2.000000 x = [0.894427 -0.447214] y = [1.788854 -0.894427]</div><div class="line">000009/000009 lambda = 2.000000 x = [0.894427 -0.447214] y = [1.788854 -0.894427]</div></pre></td></tr></table></figure>
<h2 id="Create-pip-package"><a href="#Create-pip-package" class="headerlink" title="Create pip package"></a>Create pip package</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ bazel build -c opt --config=cuda //tensorflow/tools/pip_package:build_pip_package</div><div class="line"></div><div class="line">$ bazel-bin/tensorflow/tools/pip_package/build_pip_package /tmp/tensorflow_pkg</div><div class="line"></div><div class="line"># The name of the .whl file will depend on your platform.</div><div class="line">$ sudo pip install /tmp/tensorflow_pkg/tensorflow-0.10.0rc0-py2-none-any.whl</div></pre></td></tr></table></figure>
<h1 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h1><p>到此就大功告成，開始享受 GPU 加速之後的威力，以及…更多的 GPU 問題。</p>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><ul>
<li><a href="http://textminingonline.com/dive-into-tensorflow-part-iii-gtx-1080-ubuntu16-04-cuda8-0-cudnn5-0-tensorflow" target="_blank" rel="external">Dive Into TensorFlow, Part III</a></li>
<li><a href="https://github.com/tensorflow/tensorflow/issues/3760" target="_blank" rel="external">Ubuntu 16.04 / Gpu 1080 Version compile Error (Tensorflow installation) </a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://raix852.github.io/2016/08/21/tensorflow-gpu-installation/" data-id="cj29ugzvj000ndlr1tf2xlj2y" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/tensorflow/">tensorflow</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Bot/">Bot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CI/">CI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Deep-Learning/">Deep Learning</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Encryption/">Encryption</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Filesystem/">Filesystem</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Github/">Github</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kubernetes/">Kubernetes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LDAP/">LDAP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Machine-Learning/">Machine Learning</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NLP/">NLP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TLS/">TLS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Udacity/">Udacity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gitlab/">gitlab</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openssl/">openssl</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tensorflow/">tensorflow</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/學習筆記/">學習筆記</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/日記/">日記</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/讀書心得/">讀書心得</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Bot/" style="font-size: 10px;">Bot</a> <a href="/tags/CI/" style="font-size: 10px;">CI</a> <a href="/tags/Deep-Learning/" style="font-size: 16.67px;">Deep Learning</a> <a href="/tags/Encryption/" style="font-size: 10px;">Encryption</a> <a href="/tags/Filesystem/" style="font-size: 10px;">Filesystem</a> <a href="/tags/Github/" style="font-size: 13.33px;">Github</a> <a href="/tags/Kubernetes/" style="font-size: 20px;">Kubernetes</a> <a href="/tags/LDAP/" style="font-size: 10px;">LDAP</a> <a href="/tags/Linux/" style="font-size: 16.67px;">Linux</a> <a href="/tags/Machine-Learning/" style="font-size: 16.67px;">Machine Learning</a> <a href="/tags/NLP/" style="font-size: 13.33px;">NLP</a> <a href="/tags/TLS/" style="font-size: 10px;">TLS</a> <a href="/tags/Udacity/" style="font-size: 20px;">Udacity</a> <a href="/tags/docker/" style="font-size: 20px;">docker</a> <a href="/tags/gitlab/" style="font-size: 10px;">gitlab</a> <a href="/tags/hexo/" style="font-size: 13.33px;">hexo</a> <a href="/tags/openssl/" style="font-size: 10px;">openssl</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/tensorflow/" style="font-size: 13.33px;">tensorflow</a> <a href="/tags/學習筆記/" style="font-size: 20px;">學習筆記</a> <a href="/tags/日記/" style="font-size: 13.33px;">日記</a> <a href="/tags/讀書心得/" style="font-size: 10px;">讀書心得</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">九月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">七月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">六月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">五月 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/05/03/gitlab-ci/">使用 Gitlab CI</a>
          </li>
        
          <li>
            <a href="/2017/04/17/slackbot/">建立 Slack Bot</a>
          </li>
        
          <li>
            <a href="/2017/02/03/deeplearning-ch1/">Deep learning 讀書筆記 - CH. 1</a>
          </li>
        
          <li>
            <a href="/2016/11/01/ldap/">LDAP 介紹與架設</a>
          </li>
        
          <li>
            <a href="/2016/10/23/Microservices/">Scalable Microservices with Kubernetes - Lesson 4</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 Raix<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>