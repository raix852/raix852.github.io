<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Raix&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="My garden, my knowledge, my soul.">
<meta property="og:type" content="website">
<meta property="og:title" content="Raix's Blog">
<meta property="og:url" content="http://raix852.github.io/index.html">
<meta property="og:site_name" content="Raix's Blog">
<meta property="og:description" content="My garden, my knowledge, my soul.">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Raix's Blog">
<meta name="twitter:description" content="My garden, my knowledge, my soul.">
  
    <link rel="alternate" href="/atom.xml" title="Raix&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Raix&#39;s Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">知識不經整理，無法累積。智慧不經思考，無法成長。</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="Flux RSS"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Rechercher"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://raix852.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-Microservices" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/10/22/Microservices/" class="article-date">
  <time datetime="2016-10-22T08:30:00.000Z" itemprop="datePublished">2016-10-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/22/Microservices/">Scalable Microservices with Kubernetes - Lesson 3</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>第三堂課介紹 Kubernetes。</p>
<p><strong>Conway’s Law</strong><br><br>Organizations which design systems … are constrained to produce designs which are copies of the communication structures of these organizations</p>
<h2 id="What-is-Kubernetes"><a href="#What-is-Kubernetes" class="headerlink" title="What is Kubernetes?"></a>What is Kubernetes?</h2><p>將程式包成 container 只解決了 5% 的問題。真實的問題是</p>
<ul>
<li><strong>App Configuration</strong></li>
<li><strong>Service Discovery</strong></li>
<li><strong>Managing Updates</strong></li>
<li><strong>Monitoring</strong></li>
</ul>
<p>Kubernetes 提供了新一層 abstractions 來包覆 deployment，讓使用者可以專注於大局。<br>Kubernetes 可以讓我們將每台機器抽象起來，讓操作 cluster 起來就像邏輯上操作一台機器一樣。<br>在 Kubernetes 裡，描述一串 applications ，設定如何互動，並使之發生。</p>
<h2 id="Setting-up-Kubernetes-for-this-course"><a href="#Setting-up-Kubernetes-for-this-course" class="headerlink" title="Setting up Kubernetes for this course"></a>Setting up Kubernetes for this course</h2><p>課程上是使用 Google Cloud Platform(GCP)，而我是準備一台 Ubuntu server ，上面安裝好 Kubernetes 來進行這個課程。<br><br><a href="https://github.com/udacity/ud615" target="_blank" rel="external">Course Repo</a></p>
<h2 id="Get-started"><a href="#Get-started" class="headerlink" title="Get started"></a>Get started</h2><h3 id="Launch-a-single-instance"><a href="#Launch-a-single-instance" class="headerlink" title="Launch a single instance"></a>Launch a single instance</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ kubectl run nginx --image=nginx:1.10.0</div></pre></td></tr></table></figure>
<p>將 nginx container 透過 kubectl 指令啟動</p>
<h3 id="Get-pods"><a href="#Get-pods" class="headerlink" title="Get pods"></a>Get pods</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ kubectl get pods</div></pre></td></tr></table></figure>
<p>在 Kubernetes 裡，所有的 Containers 運行在 pod ，使用上述指令列出正在運行的 pods</p>
<h3 id="Expose-nginx"><a href="#Expose-nginx" class="headerlink" title="Expose nginx"></a>Expose nginx</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ kubectl expose deployment nginx --port 80 --type LoadBalancer</div></pre></td></tr></table></figure>
<p>上面指令會建立出 load balancer 且派發一個 public IP 在上面，並將 80 port 暴露給外面。任何一個 Client 透過派發的 IP 連線將會經過 load balancer 傳送到內部 container，在這邊的例子是 nginx 。</p>
<h3 id="List-services"><a href="#List-services" class="headerlink" title="List services"></a>List services</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ kubectl get services</div></pre></td></tr></table></figure>
<p>列出 services 資訊，像是 Public IP, expose port 。</p>
<h2 id="Pods"><a href="#Pods" class="headerlink" title="Pods"></a>Pods</h2><p>Kubernetes 的核心是 Pods ，Pods 代表的是 Logical Application 。<br></p>
<ul>
<li><strong>One or more containers</strong> - 將具有依賴關係的 containers 包在同一個 pod 裡。</li>
<li><strong>Volumes</strong> - containers 放置資料的地方，可以被所有在 pod 裡的 containers 使用</li>
<li><strong>Shared namespace</strong> - Shared namespace 表示在相同 pod 裡的 containers 互相溝通，並分享相同的 Volumes</li>
<li><strong>One IP per pod</strong> - 在同一個 pod 裡的 containers 共享相同的 public IP 。</li>
</ul>
<h3 id="Pods-Configuration"><a href="#Pods-Configuration" class="headerlink" title="Pods Configuration"></a>Pods Configuration</h3><p>在 Kubernetes 裡，建立 pods 是透過設定 yaml 格式的設定檔。如下 <code>monolith.yaml</code>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">$ cat pods/monolith.yaml</div><div class="line">apiVersion: v1</div><div class="line">kind: Pod</div><div class="line">metadata:</div><div class="line">  name: monolith</div><div class="line">  labels:</div><div class="line">    app: monolith</div><div class="line">spec:</div><div class="line">  containers:</div><div class="line">    - name: monolith</div><div class="line">      image: udacity/example-monolith:1.0.0</div><div class="line">      args:</div><div class="line">        - <span class="string">"-http=0.0.0.0:80"</span></div><div class="line">        - <span class="string">"-health=0.0.0.0:81"</span></div><div class="line">        - <span class="string">"-secret=secret"</span></div><div class="line">      ports:</div><div class="line">        - name: http</div><div class="line">          containerPort: 80</div><div class="line">        - name: health</div><div class="line">          containerPort: 81</div><div class="line">      resources:</div><div class="line">        limits:</div><div class="line">          cpu: 0.2</div><div class="line">          memory: <span class="string">"10Mi"</span></div></pre></td></tr></table></figure>
<p>在 <code>contains:</code> 底下標示 container 的屬性。包含</p>
<ul>
<li><code>name:</code> : container 名稱</li>
<li><code>image:</code> : 要使用的 container image</li>
<li><code>args:</code> Application 執行時所需的參數</li>
<li><code>port:</code> : 需要暴露給外面的 ports</li>
<li><code>resources:</code> : 限制 cpu 和記憶體使用量。</li>
</ul>
<h3 id="Create-the-pod"><a href="#Create-the-pod" class="headerlink" title="Create the pod"></a>Create the pod</h3><p>將設定好的 <code>monolith.yaml</code> 透過底下指令將 monolith pod 建立出來。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ kubectl create <span class="_">-f</span> pods/monolith.yaml</div><div class="line">pod <span class="string">"monolith"</span> created</div></pre></td></tr></table></figure>
<h3 id="Examine-pods"><a href="#Examine-pods" class="headerlink" title="Examine pods"></a>Examine pods</h3><p>在 pod 剛建立出來時需要準備一段時間讓 container 啟動。透過以下指令觀察是否建立出來以及正在運行。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ kubectl get pods</div><div class="line">NAME       READY     STATUS    RESTARTS   AGE</div><div class="line">monolith   1/1       Running   0          14s</div></pre></td></tr></table></figure>
<h3 id="Describe-pods"><a href="#Describe-pods" class="headerlink" title="Describe pods"></a>Describe pods</h3><p>需要檢查詳細的資訊可以透過以下指令。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ kubectl describe pods monolith</div></pre></td></tr></table></figure>
<p>會列出 container 被指派的 IP，暴露的 port ，以及其他許多的 metadata 和發生的 events log。</p>
<h3 id="Port-forward"><a href="#Port-forward" class="headerlink" title="Port forward"></a>Port forward</h3><p>設定一個或多個 local port 轉送到 pod 裡的 port。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ kubectl port-forward monolith 10080:80</div><div class="line">Forwarding from 127.0.0.1:10080 -&gt; 80</div><div class="line">Forwarding from [::1]:10080 -&gt; 80</div></pre></td></tr></table></figure>
<p>這道指令會處於 listen 狀態，開啟另一個 terminal 測試 monolith 連線。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ curl http://127.0.0.1:10080</div><div class="line">&#123;<span class="string">"message"</span>:<span class="string">"Hello"</span>&#125;</div><div class="line">$ curl http://127.0.0.1:10080/secure</div><div class="line">authorization failed</div></pre></td></tr></table></figure>
<p>測試 login。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ curl -u user http://127.0.0.1:10080/login</div><div class="line">Enter host password <span class="keyword">for</span> user <span class="string">'user'</span>: password</div><div class="line">&#123;<span class="string">"token"</span>:<span class="string">"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InVzZXJAZXhhbXBsZS5jb20iLCJleHAiOjE0NzcxNTA3ODQsImlhdCI6MTQ3Njg5MTU4NCwiaXNzIjoiYXV0aC5zZXJ2aWNlIiwic3ViIjoidXNlciJ9.Rgm5BBG8VSiLH-u26Am1QAaXtz05nzvfWWZhHjOcaus"</span>&#125;</div><div class="line">$ curl -H <span class="string">"Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InVzZXJAZXhhbXBsZS5jb20iLCJleHAiOjE0NzcxNTA3ODQsImlhdCI6MTQ3Njg5MTU4NCwiaXNzIjoiYXV0aC5zZXJ2aWNlIiwic3ViIjoidXNlciJ9.Rgm5BBG8VSiLH-u26Am1QAaXtz05nzvfWWZhHjOcaus"</span> http://127.0.0.1:10080/secure</div><div class="line">&#123;<span class="string">"message"</span>:<span class="string">"Hello"</span>&#125;</div></pre></td></tr></table></figure>
<h3 id="View-logs"><a href="#View-logs" class="headerlink" title="View logs"></a>View logs</h3><p>列出 pod 裡的 container log。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$ kubectl logs monolith</div><div class="line">2016/10/19 15:04:10 Starting server...</div><div class="line">2016/10/19 15:04:10 Health service listening on 0.0.0.0:81</div><div class="line">2016/10/19 15:04:10 HTTP service listening on 0.0.0.0:80</div><div class="line">127.0.0.1:59954 - - [Wed, 19 Oct 2016 15:22:34 UTC] <span class="string">"GET / HTTP/1.1"</span> curl/7.47.0</div><div class="line">127.0.0.1:59986 - - [Wed, 19 Oct 2016 15:22:48 UTC] <span class="string">"GET /secure HTTP/1.1"</span> curl/7.47.0</div><div class="line">127.0.0.1:33138 - - [Wed, 19 Oct 2016 15:38:29 UTC] <span class="string">"GET /login HTTP/1.1"</span> curl/7.47.0</div><div class="line">127.0.0.1:33226 - - [Wed, 19 Oct 2016 15:39:26 UTC] <span class="string">"GET /login HTTP/1.1"</span> curl/7.47.0</div><div class="line">127.0.0.1:33252 - - [Wed, 19 Oct 2016 15:39:43 UTC] <span class="string">"GET /login HTTP/1.1"</span> curl/7.47.0</div><div class="line">127.0.0.1:33430 - - [Wed, 19 Oct 2016 15:41:41 UTC] <span class="string">"GET /secure HTTP/1.1"</span> curl/7.47.0</div><div class="line">127.0.0.1:33492 - - [Wed, 19 Oct 2016 15:42:20 UTC] <span class="string">"GET /secure HTTP/1.1"</span> curl/7.47.0</div></pre></td></tr></table></figure>
<p>加 <code>-f</code> 進入 stream 模式，監控即時 log 。</p>
<h3 id="Enter-container"><a href="#Enter-container" class="headerlink" title="Enter container"></a>Enter container</h3><p>需要像 <code>docker exec</code> 進入 container 執行指令的話，透過底下指令。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ kubectl <span class="built_in">exec</span> monolith --stdin --tty -c monolith /bin/sh</div><div class="line">/ <span class="comment">#</span></div></pre></td></tr></table></figure>
<h2 id="Monitor-and-Health-Checks"><a href="#Monitor-and-Health-Checks" class="headerlink" title="Monitor and Health Checks"></a>Monitor and Health Checks</h2><p>Kubernetes 提供了 Health Checks 機制，讓使用者自訂檢查 applications 健康狀態和 readiness check。<br>Readiness check 用來確認 pod 是否已經準備好可以提供服務，當 check failed 時，container 會被標記成 not ready 並從 load balancer 中移除。<br>Liveness probe 檢查 container 是否活著，如果檢查多次失敗， container 將會重啟。</p>
<h3 id="問題練習"><a href="#問題練習" class="headerlink" title="問題練習"></a>問題練習</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">$ cat pods/monolith.yaml</div><div class="line">...</div><div class="line">  livenessProbe:</div><div class="line">    httpGet:</div><div class="line">      path: /healthz</div><div class="line">      port: 81</div><div class="line">      scheme: HTTP</div><div class="line">    initialDelaySeconds: 5</div><div class="line">    periodSeconds: 15</div><div class="line">    timeoutSeconds: 5</div><div class="line">  readinessProbe:</div><div class="line">    httpGet:</div><div class="line">      path: /readiness</div><div class="line">      port: 81</div><div class="line">      scheme: HTTP</div><div class="line">    initialDelaySeconds: 5</div><div class="line">    timeoutSeconds: 1</div><div class="line"></div><div class="line"></div><div class="line">$ kubectl create <span class="_">-f</span> pods/monolith.yaml</div><div class="line">pod <span class="string">"healthy-monolith"</span> created</div><div class="line"></div><div class="line">$ kubectl describe pods healthy-monolith</div><div class="line">...</div><div class="line">  State:		Running</div><div class="line">    Started:		Fri, 21 Oct 2016 22:37:12 +0800</div><div class="line">  Ready:		True</div><div class="line">  Restart Count:	0</div><div class="line">  Liveness:		http-get http://:81/healthz delay=5s timeout=5s period=15s <span class="comment">#success=1 #failure=3</span></div><div class="line">  Readiness:		http-get http://:81/readiness delay=5s timeout=1s period=10s <span class="comment">#success=1 #failure=3</span></div><div class="line">...</div></pre></td></tr></table></figure>
<p>使用 healthy-monolith pod，回答下面三個問題。</p>
<ul>
<li><p>How is the readiness probe performed?</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">readinessProbe:</div><div class="line">  httpGet:</div><div class="line">    path: /readiness</div><div class="line">    port: 81</div><div class="line">    scheme: HTTP</div><div class="line">  initialDelaySeconds: 5</div><div class="line">  timeoutSeconds: 1</div></pre></td></tr></table></figure>
</li>
<li><p>How often is the readiness checked?<br><code>period=10s</code></p>
</li>
<li>How often is the liveness probe checked?<br><code>period=15s</code></li>
</ul>
<h2 id="Secret-and-ConfigMap"><a href="#Secret-and-ConfigMap" class="headerlink" title="Secret and ConfigMap"></a>Secret and ConfigMap</h2><p>ConfigMap 和 Secret 相似，但是 ConfigMap 用來存放較不敏感的資料，而像密碼或金鑰之類的需要安全性的資料則使用 Secret。 Secret 會在 pod 建立時， mount 到 container 裡當作 volume，讓 container 擁有和使用。</p>
<p><a href="http://kubernetes.io/docs/user-guide/configmap/" target="_blank" rel="external">ConfigMap</a><br><a href="http://kubernetes.io/docs/user-guide/secrets/" target="_blank" rel="external">Secrets</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Create secret</span></div><div class="line">$ kubectl create secret generic tls-certs --from-file=tls/</div><div class="line"><span class="comment"># Use secure-monolith pod</span></div><div class="line">$ kubectl create <span class="_">-f</span> pods/secure-monolith.yaml</div></pre></td></tr></table></figure>
<p>以下使用 nginx reverse proxy 為例子，將 https(443 port) 連線轉送到 http(80 port)。</p>
<h3 id="Create-secret"><a href="#Create-secret" class="headerlink" title="Create secret"></a>Create secret</h3><p>https 連線需要 Certificate ，使用 secret 將 Certificate 封裝起來。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ kubectl create secret generic tls-certs --from-file=tls/</div></pre></td></tr></table></figure>
<h3 id="Describe-secret"><a href="#Describe-secret" class="headerlink" title="Describe secret"></a>Describe secret</h3><p>kubectl will create a key for each file in the tls directory under the tls-certs secret bucket. Use the <code>kubectl describe</code> command to verify that:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ kubectl describe secrets tls-certs</div></pre></td></tr></table></figure>
<h3 id="Create-ConfigMap"><a href="#Create-ConfigMap" class="headerlink" title="Create ConfigMap"></a>Create ConfigMap</h3><p>將 nginx reverse proxy 的設定透過 ConfigMap 封裝起來。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ kubectl create configmap nginx-proxy-conf --from-file=nginx/proxy.conf</div></pre></td></tr></table></figure>
<h3 id="Describe-ConfigMap"><a href="#Describe-ConfigMap" class="headerlink" title="Describe ConfigMap"></a>Describe ConfigMap</h3><p>透過 <code>kubectl describe configmap</code> 獲得詳細的資訊。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ kubectl describe configmap nginx-proxy-conf</div></pre></td></tr></table></figure>
<h3 id="操作練習"><a href="#操作練習" class="headerlink" title="操作練習"></a>操作練習</h3><p>使用 secure-monolith pod 作為這次練習。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line">$ cat pods/secure-monolith.yaml</div><div class="line"></div><div class="line">apiVersion: v1</div><div class="line">kind: Pod</div><div class="line">metadata:</div><div class="line">  name: <span class="string">"secure-monolith"</span></div><div class="line">  labels:</div><div class="line">    app: monolith</div><div class="line">spec:</div><div class="line">  containers:</div><div class="line">    - name: nginx</div><div class="line">      image: <span class="string">"nginx:1.9.14"</span></div><div class="line">      lifecycle:</div><div class="line">        preStop:</div><div class="line">          <span class="built_in">exec</span>:</div><div class="line">            <span class="built_in">command</span>: [<span class="string">"/usr/sbin/nginx"</span>,<span class="string">"-s"</span>,<span class="string">"quit"</span>]</div><div class="line">      volumeMounts:</div><div class="line">        - name: <span class="string">"nginx-proxy-conf"</span></div><div class="line">          mountPath: <span class="string">"/etc/nginx/conf.d"</span></div><div class="line">        - name: <span class="string">"tls-certs"</span></div><div class="line">          mountPath: <span class="string">"/etc/tls"</span></div><div class="line">    - name: monolith</div><div class="line">      image: <span class="string">"udacity/example-monolith:1.0.0"</span></div><div class="line">      ports:</div><div class="line">        - name: http</div><div class="line">          containerPort: 80</div><div class="line">        - name: health</div><div class="line">          containerPort: 81</div><div class="line">      resources:</div><div class="line">        limits:</div><div class="line">          cpu: 0.2</div><div class="line">          memory: <span class="string">"10Mi"</span></div><div class="line">      livenessProbe:</div><div class="line">        httpGet:</div><div class="line">          path: /healthz</div><div class="line">          port: 81</div><div class="line">          scheme: HTTP</div><div class="line">        initialDelaySeconds: 5</div><div class="line">        periodSeconds: 15</div><div class="line">        timeoutSeconds: 5</div><div class="line">      readinessProbe:</div><div class="line">        httpGet:</div><div class="line">          path: /readiness</div><div class="line">          port: 81</div><div class="line">          scheme: HTTP</div><div class="line">        initialDelaySeconds: 5</div><div class="line">        timeoutSeconds: 1</div><div class="line">  volumes:</div><div class="line">    - name: <span class="string">"tls-certs"</span></div><div class="line">      secret:</div><div class="line">        secretName: <span class="string">"tls-certs"</span></div><div class="line">    - name: <span class="string">"nginx-proxy-conf"</span></div><div class="line">      configMap:</div><div class="line">        name: <span class="string">"nginx-proxy-conf"</span></div><div class="line">        items:</div><div class="line">          - key: <span class="string">"proxy.conf"</span></div><div class="line">            path: <span class="string">"proxy.conf"</span></div></pre></td></tr></table></figure>
<p>在 secure-monolith pod 設定裡，可以看到使用兩個 container ，分別為 nginx 和 monolith ， nginx 會作為 reverse proxy 將連線導入 monolith 。</p>
<p>在 nginx 設定裡，有設定 <code>lifecycle</code> 當 nginx container 要關閉時，先執行所設定的 command ，清理剩餘的工作。在 <code>volumeMounts</code> 裡，設定先前建立的 secret 和 ConfigMap ，將之 mount。</p>
<h3 id="Create-secure-monolith-pod"><a href="#Create-secure-monolith-pod" class="headerlink" title="Create secure-monolith pod"></a>Create secure-monolith pod</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Create the secure-monolith Pod using kubectl.</div><div class="line"></div><div class="line">kubectl create <span class="_">-f</span> pods/secure-monolith.yaml</div><div class="line">kubectl get pods secure-monolith</div></pre></td></tr></table></figure>
<h3 id="Check-connection"><a href="#Check-connection" class="headerlink" title="Check connection"></a>Check connection</h3><p>使用先前學過的 port-forward 指令，將 local 10443 port 開通到 nginx 443 port ，測試 TLS 連線能不能相通。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">kubectl port-forward secure-monolith 10443:443</div><div class="line"></div><div class="line">curl --cacert tls/ca.pem https://127.0.0.1:10443</div><div class="line"></div><div class="line">kubectl logs -c nginx secure-monolith</div></pre></td></tr></table></figure>
<h2 id="Services"><a href="#Services" class="headerlink" title="Services"></a>Services</h2><p>不管是使用 pod 還是 docker container ，都會遇到一個問題是，container 會因各種原因需要進行重啟，而重啟時 IP 會重新指派，因此無法仰賴固定的 IP 。因此 Kubernetes 引入 Services 當作 pod 的 abstraction ，由 Services 當作是 pods 前端，提供穩定的連接，因此後端的 pods 的更動，就不會影響整體。</p>
<p>Persistent Endpoint for Pods<br></p>
<ul>
<li>Use labels to select pods</li>
<li>Internal or External IP</li>
</ul>
<h3 id="Create-Services"><a href="#Create-Services" class="headerlink" title="Create Services"></a>Create Services</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">$ cat services/monolith.yaml</div><div class="line">kind: Service</div><div class="line">apiVersion: v1</div><div class="line">metadata:</div><div class="line">  name: <span class="string">"monolith"</span></div><div class="line">spec:</div><div class="line">  selector:</div><div class="line">    app: <span class="string">"monolith"</span></div><div class="line">    secure: <span class="string">"enabled"</span></div><div class="line">  ports:</div><div class="line">    - protocol: <span class="string">"TCP"</span></div><div class="line">      port: 443</div><div class="line">      targetPort: 443</div><div class="line">      nodePort: 31000</div><div class="line">  <span class="built_in">type</span>: NodePort</div></pre></td></tr></table></figure>
<p>Services 設定裡透過 <code>selector</code> 將有符合 label 的 pods 選出來聚在一起。並把所有 pods 443 port 暴露出來，讓 local 31000 port 轉到 pods 443 port。</p>
<p>接著建立 services 。<br><br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ kubectl create <span class="_">-f</span> services/monolith.yaml</div></pre></td></tr></table></figure></p>
<p>這時 services 沒有選擇到任何東西 ，因為沒有一個 pod 的 label 符合，可以透過以下指令檢查。<br><br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ kubectl get pods <span class="_">-l</span> <span class="string">"app=monolith,secure=enabled"</span></div></pre></td></tr></table></figure></p>
<p>將 secure-monolith pod 加入 label。 <br><br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ kubectl label pods secure-monolith <span class="string">"secure=enabled"</span></div><div class="line">$ kubectl get pods <span class="_">-l</span> <span class="string">"app=monolith,secure=enabled"</span></div><div class="line">NAME              READY     STATUS    RESTARTS   AGE</div><div class="line">secure-monolith   2/2       Running   0          5h</div></pre></td></tr></table></figure></p>
<p>此時 services 就可以接管 secure-monolith pod 。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://raix852.github.io/2016/10/22/Microservices/" data-id="ciukybs56000lhype55n8jtnr" class="article-share-link">Partager</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Kubernetes/">Kubernetes</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Udacity/">Udacity</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/">docker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/學習筆記/">學習筆記</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Microservices" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/10/12/Microservices/" class="article-date">
  <time datetime="2016-10-12T15:00:00.000Z" itemprop="datePublished">2016-10-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/12/Microservices/">Scalable Microservices with Kubernetes - Lesson 2</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>第二節課在教 docker 觀念以及如何使用，內容對初心者而言非常簡易上手，對我來說也可當作複習的機會。</p>
<h2 id="Why-docker"><a href="#Why-docker" class="headerlink" title="Why docker?"></a>Why docker?</h2><p>docker 所使用的 image 不只包含程式本身，所需要的 dependencies 和執行時所需的設定檔也都包含在內。docker 本身也提供良好的 API</p>
<ul>
<li><strong>create</strong></li>
<li><strong>distribute</strong></li>
<li><strong>run</strong></li>
</ul>
<p>container 在 server 上。目前支援的 OS 平台有 linux 和 windows。</p>
<p>docker 可以幫助系統管理者作到</p>
<ul>
<li><strong>Reproducable</strong></li>
<li><strong>Consistant</strong></li>
</ul>
<p>docker 可以提供類似 virtual machine 的功能，將執行程式從同一台機器上隔離出來，因此可不用擔心各種 dependencies 問題。</p>
<h2 id="docker-擅長什麼？"><a href="#docker-擅長什麼？" class="headerlink" title="docker 擅長什麼？"></a>docker 擅長什麼？</h2><p>常見的 linux 發布版(Ex. Ubuntu, Redhat) ，擅長於</p>
<ul>
<li><strong>Installing Services</strong></li>
<li><strong>Start and Stop Services</strong></li>
</ul>
<p>docker 在這之上，提供了</p>
<ul>
<li><strong>Installing Services</strong></li>
<li><strong>Start and Stop Services</strong></li>
<li><strong>Running multiple versions</strong></li>
<li><strong>Running multiple instances</strong></li>
</ul>
<p>舉例，要使用 nginx 套件， linux 的套件管理程式可以方便下載，並透過 systemd 或舊的 init.d 將 nginx 啟動。但假設需要在同一台機器上啟動多個 nginx 服務或使用不同的版本，此時就會遇到瓶頸，因為同一時間只能跑一個。而 docker 則可以提供運行多個 instances 和多個版本的能力。</p>
<h2 id="Containers"><a href="#Containers" class="headerlink" title="Containers"></a>Containers</h2><p>可以讓 applications 方便運行和發布到不同平台上的技術。</p>
<ul>
<li><strong>Independent packages</strong> - 將所需要的 dependencies 打包起來，發布到各種平台上。</li>
<li><strong>Namespace isolation</strong> - 提供 filesystem 的 Iiolation 和 network isolatation，讓檔案名稱或 ip/port 不會衝突。</li>
</ul>
<p>與一般的 virtual machine 透過模擬整個 OS 層不同， container 是經由 linux kernel 由邏輯上分割出來，透過 Namespace 隔離和 cgroup 控制 resources 達成，因此可視為輕量級的 VM ，啟動和關閉都非常快速。</p>
<h2 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h2><p>docker 用來建立 image 的檔案，裡面描述指令讓 docker 依指示要從哪個 base image 開始，逐漸將所需要的 dependencies 打包起來，最後完成一個包含所有套件和設定的 application image 來使用。</p>
<p>以下是之前做過得小型 java 7 image，使用 centos 7.2 作為程式運行的環境。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">FROM centos:7.2.1511</div><div class="line">MAINTAINER raix</div><div class="line"></div><div class="line">USER root</div><div class="line">RUN yum install -y wget \</div><div class="line">                git \</div><div class="line">                curl \</div><div class="line">                zip \</div><div class="line">                openssh-clients \</div><div class="line">                java-1.7.0-openjdk \</div><div class="line">                java-1.7.0-openjdk-devel \</div><div class="line">                java-1.7.0-openjdk-headless</div><div class="line"></div><div class="line">ENV LANG C.UTF-8</div></pre></td></tr></table></figure></p>
<h2 id="Docker-Hub"><a href="#Docker-Hub" class="headerlink" title="Docker Hub"></a>Docker Hub</h2><p>做出來的 image 可以發布到 docker hub 上，公開讓所有人使用，直接從 docker hub 上下載完整的 image 下來，而不用從頭建置起來，方便用來做大量佈署的動作。除了 docker hub 這個公開存放 image 的地方，也有其他公開的服務可以使用，像是 gcr (Google Container Registry) ，或是建立私有 hub ，供企業內部使用。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://raix852.github.io/2016/10/12/Microservices/" data-id="ciukybs53000khypeb2b6tug7" class="article-share-link">Partager</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Kubernetes/">Kubernetes</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Udacity/">Udacity</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/">docker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/學習筆記/">學習筆記</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Microservices" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/10/11/Microservices/" class="article-date">
  <time datetime="2016-10-11T15:00:00.000Z" itemprop="datePublished">2016-10-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/11/Microservices/">Scalable Microservices with Kubernetes - Lesson 1</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>這門課介紹使用 docker 、 Kubernetes  ，並且會使用 Go 和 Google cloud platform 來學習建立 Microservices 。<br>課程網址：<a href="https://classroom.udacity.com/courses/ud615/" target="_blank" rel="external">Scalable Microservices with Kubernetes</a></p>
<h2 id="什麼是-Microservices？"><a href="#什麼是-Microservices？" class="headerlink" title="什麼是 Microservices？"></a>什麼是 Microservices？</h2><ul>
<li><strong>Moduler</strong></li>
<li><strong>Easy to deploy</strong></li>
<li><strong>Scale independently</strong></li>
</ul>
<p>Microservices 設計模式可以套用在很多地方，像是 Web service。幫助快速開發和 Continuous delivery ，並將測試工具和 infrastructure 設計推上更上一層樓。</p>
<h2 id="Twelve-Factor-App"><a href="#Twelve-Factor-App" class="headerlink" title="Twelve-Factor App"></a>Twelve-Factor App</h2><p>Heroku 在 2012 年提出的 <a href="https://12factor.net/" target="_blank" rel="external">The TWELVE-FACTS APP</a>，在『建構微服務』一書中也有提到這 12 條準則。</p>
<ol>
<li><strong>Codebase</strong> - One codebase tracked in revision control, many deploys</li>
<li><strong>Dependencies</strong> - Explicitly declare and isolate dependencies</li>
<li><strong>Config</strong> - Store config in the environment</li>
<li><strong>Backing services</strong> - Treat backing services as attached resources</li>
<li><strong>Build, release, run</strong> - Strictly separate build and run stages</li>
<li><strong>Processes</strong> - Execute the app as one or more stateless processes</li>
<li><strong>Port binding</strong> - Export services via port binding</li>
<li><strong>Concurrency</strong> - Scale out via the process model</li>
<li><strong>Disposability</strong> - Maximize robustness with fast startup and graceful shutdown</li>
<li><strong>Dev/prod parity</strong> - Keep development, staging, and production as similar as possible</li>
<li><strong>Logs</strong> - Treat logs as event streams</li>
<li><strong>Admin processes</strong> - Run admin/management tasks as one-off processes</li>
</ol>
<p>Twelve-Factor App 可歸類成下列三個重要因素：</p>
<ul>
<li><strong>Portability</strong> - 消除執行環境的不同，像是 dependencies 和 configuration</li>
<li><strong>Deployability</strong> - 可持續佈署在不同環境，或是不同的雲服務商(AWS, GCP)</li>
<li><strong>Scalability</strong> - 根據使用者需求擴充服務能力。</li>
</ul>
<h2 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a>JWT</h2><p>JSON Web Token，用來做：</p>
<ul>
<li><strong>Authentication</strong> - 可被使用者簽證</li>
<li><strong>Information Exchange</strong> - 可打包訊息</li>
</ul>
<p>JWT 可被眾多語言支援 encode / decode ，常用於 Authentication 。</p>
<h2 id="How-does-JWT-work"><a href="#How-does-JWT-work" class="headerlink" title="How does JWT work?"></a>How does JWT work?</h2><ol>
<li>Client 端傳送使用者帳號和密碼到 Server 上</li>
<li>Server 驗證完使用者之後，建立 JWT Token</li>
<li>傳送 JWT Token 到 Client 端，由 Client 端保存</li>
<li>Client 端傳送 request ，並附上 JWT Token</li>
<li>Server 端驗證 JWT Token 是否正確</li>
<li>驗證成功， Server 端傳回 request 的 response</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://raix852.github.io/2016/10/11/Microservices/" data-id="ciukybs4z000ihypegjmowi1p" class="article-share-link">Partager</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Kubernetes/">Kubernetes</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Udacity/">Udacity</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/">docker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/學習筆記/">學習筆記</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-read-report" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/09/13/read-report/" class="article-date">
  <time datetime="2016-09-12T17:00:00.000Z" itemprop="datePublished">2016-09-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/09/13/read-report/">台灣史上最有梗的台灣史</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="http://i.imgur.com/tYhUNK1.jpg" alt="台灣史上最有梗的台灣史-封面"></p>
<p>說起 PTT 上的『藏書界的竹野內豐』，有誰不認識呢？偶爾逛逛八卦板，看到這位作者的文章一出現，推文立刻就是推到暴，描述台灣的歷史或者是聊起藏書起來，莫不是又有梗又好笑，而且還可以兼具知識傳播，了解歷史內涵，真是讓人敬仰不已。我媽都說我怎麼跪著看 PTT ！</p>
<p>本書從封面一開始，就呈現出不正經的風格，圖上那個鄭成功，不就是放某位姍姍來遲的莊X大師嗎？翻開第一頁，是先展示過去的歷史文獻圖片，下面加註不正經的講解和吐槽，這之間的反差讓人更容易想像當時的環境，引起共鳴，讀歷史的趣味也因此出來。</p>
<p>書中講述的歷史，從最早的原民歷史開始，到第代的台灣為止，之間經歷的朝代各自歸納成一章。書中出現的歷史人物，除了我們從小在歷史課本中耳熟能詳的人物之外，也多描述了一些小人物，或是和這些歷史人物有關的傳說或軼聞。像是在描述鄭成功，開頭標題就描述『我查證過了，很清楚，鄭成功是型男。』，還有鄭成功雖然在台灣統治上只有短短的六個月，但是台灣各地由北到南都有留下不少鄭成功在當地的事蹟傳說，讓人不禁想到他是多麼賣力在製造傳說阿XD。當然，鄭成功哪有那麼有空走遍全台灣，因此很多都是當地人為和心目中的偶像有連結，製造出來的也說不定，這也顯示了鄭成功的影響力對台灣是多麼地大。</p>
<p>另一位書中提及的歷史人物『王得祿』，這是一般歷史教科書上不會寫上的人物，但是卻是台灣在清朝時代裡擔任過最高的官位。王得祿出身於貧賤人家，從小父母雙亡，和哥哥、嫂子住在一起，傳聞提及嫂子曾看到他的真身是一條蛇，和龍有不少相關，因此認定他必成大器。在當時有海盜作亂，清廷招人入伍，王得祿便加入軍隊，帶上嫂子編織的鞋子，擔任舉軍旗的角色。在和海盜作戰的過程中，一開始是被打敗面臨要撤退的情況，此時王得祿因鞋子掉在前線，舉起軍旗要回去撿，這時軍隊看到軍旗往前衝，就以為是要回攻的訊號，，而海盜也看到軍旗向前，認為援兵已到，自己也慌張起來。結果反而打贏了這場杖，王得祿就因此開始了他的官途。最後過世時，民間也留下不少死亡傳說。</p>
<p>通篇讀完，並不會像吃了撒尿牛丸一樣歷史靈光了很多，每次考試都考一百分。但是結合不少 PTT 上常見的梗，讓人讀起歷史起來非有趣，因此推薦當作是入門的書籍，書中沒有提及但是有列出關鍵字的議題可以作為後續深入的主題。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://raix852.github.io/2016/09/13/read-report/" data-id="ciukybs4x000ghypeu1jf81mv" class="article-share-link">Partager</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/讀書心得/">讀書心得</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-tensorflow-gpu-installation" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/08/21/tensorflow-gpu-installation/" class="article-date">
  <time datetime="2016-08-21T14:00:00.000Z" itemprop="datePublished">2016-08-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/21/tensorflow-gpu-installation/">Tensorflow gtx 1060 installation</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>上個禮拜電腦在開機時又開始產生了異常狀況，算一算大概壽命快要到達盡頭了。於是心一狠準備花大錢來組台新的來使用，目標是可以讓 tensorflow 跑 GPU 的版本。原訂目標是直上 gtx 1080 ，後來和朋友討論之後是不需要太衝動買這張，但是又要有一定的效能和記憶體容量，考量了一下價錢，最後選擇了 msi gtx 1060 版本。因此目前新的這一台系統環境如下：</p>
<p><img src="http://i.imgur.com/8jdWJYV.png" alt="System Info"></p>
<h1 id="環境準備"><a href="#環境準備" class="headerlink" title="環境準備"></a>環境準備</h1><h2 id="安裝-nvidia-driver"><a href="#安裝-nvidia-driver" class="headerlink" title="安裝 nvidia driver"></a>安裝 nvidia driver</h2><p>這邊我是參考別人的作法，從 <a href="https://launchpad.net/~graphics-drivers/+archive/ubuntu/ppa" target="_blank" rel="external">“Graphics Drivers Team” team</a> 找 driver 下載，若是直接從 nvidia 官網下載 driver 步驟會比較麻煩，看 github 上的討論也有不少問題。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">sudo add-apt-repository ppa:graphics-drivers/ppa</div><div class="line">sudo apt-get update</div><div class="line">sudo apt-get install nvidia-367</div><div class="line">sudo apt-get install mesa-common-dev</div><div class="line">sudo apt-get install freeglut3-dev</div></pre></td></tr></table></figure>
<p>裝好後，重開機將 driver load 進來。</p>
<h2 id="安裝-dependencies-套件"><a href="#安裝-dependencies-套件" class="headerlink" title="安裝 dependencies 套件"></a>安裝 dependencies 套件</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install libglu1-mesa libxi-dev libxmu-dev libglu1-mesa-dev</div></pre></td></tr></table></figure>
<h2 id="安裝-gcc-amp-g-4-8"><a href="#安裝-gcc-amp-g-4-8" class="headerlink" title="安裝 gcc &amp; g++ 4.8"></a>安裝 gcc &amp; g++ 4.8</h2><p>在裝 CUDA 之前，需要先將 gcc &amp; g++ 準備好，由於 ubuntu 預設是使用 4.5 ，因此需要裝額外的版本。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">sudo add-apt-repository ppa:ubuntu-toolchain-r/<span class="built_in">test</span></div><div class="line">sudo apt-get update</div><div class="line">sudo apt-get install gcc-4.8</div><div class="line">sudo apt-get install g++-4.8</div><div class="line">sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-4.8 50</div><div class="line">sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-4.8 50</div></pre></td></tr></table></figure>
<p><strong>10/11 更新</strong></p>
<p>Ubuntu 16.04 使用的 gcc 版本已經非常的新 (Gcc version 5.4)，會造成 <code>#error -- unsupported GNU version! gcc versions later than 5.3 are not supported!</code> 訊息出現，需要去修改 <code>/usr/local/cuda/include/host_config.h</code> 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">#if __GNUC__ &gt; 5 || (__GNUC__ == 5 &amp;&amp; __GNUC_MINOR__ &gt; 3)</div><div class="line"></div><div class="line">//#error -- unsupported GNU version! gcc versions later than 5.3 are not supported!</div><div class="line"></div><div class="line">#endif /* __GNUC__ &gt; 5 || (__GNUC__ == 5 &amp;&amp; __GNUC_MINOR__ &gt; 1) */</div></pre></td></tr></table></figure>
<h2 id="安裝-CUDA-Toolkit-8-0"><a href="#安裝-CUDA-Toolkit-8-0" class="headerlink" title="安裝 CUDA Toolkit 8.0"></a>安裝 CUDA Toolkit 8.0</h2><p>從 <a href="https://developer.nvidia.com/cuda-release-candidate-download" target="_blank" rel="external">CUDA Toolkit 8.0</a> 裡選擇適合的版本。</p>
<p><img src="http://i.imgur.com/DCAL3eF.png" alt="CUDA Toolkit 8.0"></p>
<p>接下來執行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo bash cuda_8.0.27_linux.run</div></pre></td></tr></table></figure></p>
<p>安裝過程中第一步會詢問是否要安裝 nvidia driver ，這裡就填 <code>n</code> ，避免先前安裝的 driver 被蓋過。</p>
<p>安裝完之後，設定環境變數到 <code>.bashrc</code> 裡：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">export PATH=/usr/local/cuda-8.0/bin$&#123;PATH:+:$&#123;PATH&#125;&#125;</div><div class="line">export LD_LIBRARY_PATH=/usr/local/cuda-8.0/lib64$&#123;LD_LIBRARY_PATH:+:$&#123;LD_LIBRARY_PATH&#125;&#125;</div></pre></td></tr></table></figure>
<p>現在就可以下指令來觀察是否有正確安裝好。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">$ nvidia-smi</div><div class="line">Sun Aug 21 22:54:45 2016       </div><div class="line">+-----------------------------------------------------------------------------+</div><div class="line">| NVIDIA-SMI 367.35                 Driver Version: 367.35                    |</div><div class="line">|-------------------------------+----------------------+----------------------+</div><div class="line">| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |</div><div class="line">| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |</div><div class="line">|===============================+======================+======================|</div><div class="line">|   0  GeForce GTX 106...  Off  | 0000:01:00.0      On |                  N/A |</div><div class="line">|  0%   54C    P0    30W / 200W |    310MiB /  6069MiB |      0%      Default |</div><div class="line">+-------------------------------+----------------------+----------------------+</div><div class="line"></div><div class="line">+-----------------------------------------------------------------------------+</div><div class="line">| Processes:                                                       GPU Memory |</div><div class="line">|  GPU       PID  Type  Process name                               Usage      |</div><div class="line">|=============================================================================|</div><div class="line">|    0      3359    G   /usr/lib/xorg/Xorg                             172MiB |</div><div class="line">|    0      4089    G   cinnamon                                       104MiB |</div><div class="line">|    0      4380    G   /usr/lib/firefox/firefox                         1MiB |</div><div class="line">|    0      4523    G   ...s-passed-by-fd --v8-snapshot-passed-by-fd    31MiB |</div><div class="line">+-----------------------------------------------------------------------------+</div></pre></td></tr></table></figure>
<h2 id="安裝-cuDNN-5-0"><a href="#安裝-cuDNN-5-0" class="headerlink" title="安裝 cuDNN 5.0"></a>安裝 cuDNN 5.0</h2><p><a href="https://developer.nvidia.com/rdp/cudnn-download" target="_blank" rel="external">cuDNN Download</a> 從此處選擇 <code>Download cuDNN v5 (May 27, 2016), for CUDA 8.0 RC</code> 。</p>
<p>解壓縮後放到指定的位置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">tar -zxvf cudnn-8.0-linux-x64-v5.0-ga.tgz</div><div class="line">sudo cp cuda/include/cudnn.h /usr/local/cuda/include/</div><div class="line">sudo cp cuda/lib64/libcudnn* /usr/local/cuda/lib64/</div><div class="line">sudo chmod a+r /usr/local/cuda/include/cudnn.h</div><div class="line">sudo chmod a+r /usr/local/cuda/lib64/libcudnn*</div></pre></td></tr></table></figure>
<h1 id="安裝-Tensorflow-with-GPU"><a href="#安裝-Tensorflow-with-GPU" class="headerlink" title="安裝 Tensorflow with GPU"></a>安裝 Tensorflow with GPU</h1><p>這邊要使用最新版本的原始碼。目前 release 的 <code>r0.10 RC0</code> 有 bug 還沒有修好。</p>
<h2 id="下載原始碼"><a href="#下載原始碼" class="headerlink" title="下載原始碼"></a>下載原始碼</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git clone https://github.com/tensorflow/tensorflow.git</div></pre></td></tr></table></figure>
<h2 id="安裝-dependencies"><a href="#安裝-dependencies" class="headerlink" title="安裝 dependencies"></a>安裝 dependencies</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install openjdk-8-jdk openjdk-8-jdk-headless openjdk-8-jre</div><div class="line">sudo apt-get install python-numpy swig python-dev python-wheel</div><div class="line">sudo apt-get install python-setuptools  python-pip</div><div class="line">sudo apt-get install zlib1g-dev</div></pre></td></tr></table></figure>
<h2 id="安裝-Bazel"><a href="#安裝-Bazel" class="headerlink" title="安裝 Bazel"></a>安裝 Bazel</h2><p>Bazel 是 google 在推的 build 工具，適用於大型專案裡有不同語言和套件整合的需求上。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">wget https://github.com/bazelbuild/bazel/releases/download/0.3.1/bazel-0.3.1-installer-linux-x86_64.sh</div><div class="line">bash bazel-0.3.1-installer-linux-x86_64.sh</div></pre></td></tr></table></figure>
<h2 id="設定-Tensorflow"><a href="#設定-Tensorflow" class="headerlink" title="設定 Tensorflow"></a>設定 Tensorflow</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">$ ./configure</div><div class="line">Please specify the location of python. [Default is /usr/bin/python]:</div><div class="line">Do you wish to build TensorFlow with Google Cloud Platform support? [y/N] N</div><div class="line">No Google Cloud Platform support will be enabled for TensorFlow</div><div class="line">Do you wish to build TensorFlow with GPU support? [y/N] y</div><div class="line">GPU support will be enabled for TensorFlow</div><div class="line">Please specify which gcc nvcc should use as the host compiler. [Default is /usr/bin/gcc]:</div><div class="line">Please specify the Cuda SDK version you want to use, e.g. 7.0. [Leave empty to use system default]:</div><div class="line">Please specify the location where CUDA toolkit is installed. Refer to README.md for more details. [Default is /usr/local/cuda]:</div><div class="line">Please specify the cuDNN version you want to use. [Leave empty to use system default]:</div><div class="line">Please specify the location where cuDNN library is installed. Refer to README.md for more details. [Default is /usr/local/cuda]:</div><div class="line">Please specify a list of comma-separated Cuda compute capabilities you want to build with.</div><div class="line">You can find the compute capability of your device at: https://developer.nvidia.com/cuda-gpus.</div><div class="line">Please note that each additional compute capability significantly increases your build time and binary size.</div><div class="line"></div><div class="line">Setting up Cuda include</div><div class="line">Setting up Cuda lib</div><div class="line">Setting up Cuda bin</div><div class="line">Setting up Cuda nvvm</div><div class="line">Setting up CUPTI include</div><div class="line">Setting up CUPTI lib64</div><div class="line">Configuration finished</div></pre></td></tr></table></figure>
<p>基本上設定要啟用 GPU ，剩下的版本環境使用預設值就好。</p>
<h2 id="修改-Tensorflow"><a href="#修改-Tensorflow" class="headerlink" title="修改 Tensorflow"></a>修改 Tensorflow</h2><p>在設定完之後，接下來是測試是否可以編譯成功。在這邊編譯時會出現 ERROR: … undeclared inclusion(s) in rule … ，這邊翻到 issue 3760 裡有人提到需要修改 Tensorflow 的設定。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vim tensorflow/third_party/gpus/crosstool/CROSSTOOL</div></pre></td></tr></table></figure>
<p>在 65 行那邊加入這一行 cxx_builtin_include_directory: “/usr/local/cuda-8.0/include” ，測試加了之後就可以編譯成功。</p>
<h2 id="Build-Tensorflow-with-GPU"><a href="#Build-Tensorflow-with-GPU" class="headerlink" title="Build Tensorflow with GPU"></a>Build Tensorflow with GPU</h2><p>這裡之後就沒遇到什麼問題， 跟著官網安裝指令走就好。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$ bazel build -c opt --config=cuda //tensorflow/cc:tutorials_example_trainer</div><div class="line"></div><div class="line">$ bazel-bin/tensorflow/cc/tutorials_example_trainer --use_gpu</div><div class="line"># Lots of output. This tutorial iteratively calculates the major eigenvalue of</div><div class="line"># a 2x2 matrix, on GPU. The last few lines look like this.</div><div class="line">000009/000005 lambda = 2.000000 x = [0.894427 -0.447214] y = [1.788854 -0.894427]</div><div class="line">000006/000001 lambda = 2.000000 x = [0.894427 -0.447214] y = [1.788854 -0.894427]</div><div class="line">000009/000009 lambda = 2.000000 x = [0.894427 -0.447214] y = [1.788854 -0.894427]</div></pre></td></tr></table></figure>
<h2 id="Create-pip-package"><a href="#Create-pip-package" class="headerlink" title="Create pip package"></a>Create pip package</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ bazel build -c opt --config=cuda //tensorflow/tools/pip_package:build_pip_package</div><div class="line"></div><div class="line">$ bazel-bin/tensorflow/tools/pip_package/build_pip_package /tmp/tensorflow_pkg</div><div class="line"></div><div class="line"># The name of the .whl file will depend on your platform.</div><div class="line">$ sudo pip install /tmp/tensorflow_pkg/tensorflow-0.10.0rc0-py2-none-any.whl</div></pre></td></tr></table></figure>
<h1 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h1><p>到此就大功告成，開始享受 GPU 加速之後的威力，以及…更多的 GPU 問題。</p>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><ul>
<li><a href="http://textminingonline.com/dive-into-tensorflow-part-iii-gtx-1080-ubuntu16-04-cuda8-0-cudnn5-0-tensorflow" target="_blank" rel="external">Dive Into TensorFlow, Part III</a></li>
<li><a href="https://github.com/tensorflow/tensorflow/issues/3760" target="_blank" rel="external">Ubuntu 16.04 / Gpu 1080 Version compile Error (Tensorflow installation) </a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://raix852.github.io/2016/08/21/tensorflow-gpu-installation/" data-id="ciukybs4u000dhypehuouiryn" class="article-share-link">Partager</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/tensorflow/">tensorflow</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-PixHack2016" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/08/14/PixHack2016/" class="article-date">
  <time datetime="2016-08-14T04:00:00.000Z" itemprop="datePublished">2016-08-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/14/PixHack2016/">8/13 痞客邦克漏字比賽心得</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>昨天就是痞客幫克漏字比賽的日子，一大早7點爬起來梳洗一下就出發到現場。然而到達目的地華山文創園區時要找會場在哪時迷路了一下，在裡面繞一繞找不太到會場在哪裡。</p>
<p>進到會場後，痞客邦工作人員帶我到比賽時使用的桌子，組員其他三位都已經到達現場在為今天比賽做準備。由於我們很早就開始討論今天的比賽要怎麼做，所以到了當天只差投影片還沒有開始製作，剩下其實沒多少事。於是我就用當天得時間去詢問 AWS 無法使用 GPU instance 的問題，現場也有 AWS support 人員和工程師在場，過不了多久就順利開起來，原來是 GPU instance 預設限制使用量是0，需要去申請才可以使用。</p>
<p>既然能開啟有 GPU 的環境，那當然就是要嘗試一下利用 GPU 的計算能力來看看我們使用的 RNN 模型有沒有計算比較快。這次比賽時我們就決定好全力嘗試使用 RNN/LSTM 模型，不過過程中沒那麼順利，直到比賽前幾天才弄出了一個可以跑的模型出來。實際開始訓練已經是比賽前一天，而且訓練速度真的是慢的超乎想像，借了一台性能不錯的 server 來跑還是需要好幾個星期才能訓練完畢。不得已，我們只能先拿訓練一部份的結果來先測試看看能不能在比賽時使用。結果是在算預測值時也是需要花上不少時間，無法在比賽時拿出來用。因此在正式比賽時就不是使用 RNN ，而是使用另一組員先建好的 Word2vec 模型。</p>
<p>即使如此，有了 GPU 環境可以使用，不嘗試看看也說不過去。於是整個上午的時間，我都在弄 AWS 環境。嘗試把 tensorflow build 出使用 CUDA 的版本，過程中看似一切都很順利，最後要使用時卻會出現找不到 GPU device 的問題。鑑於時間的關係，就不去找尋找原因，而是改去找別人弄好的還境。這邊還好泡在 tensorflow community 時有看到相關的訊息，因此順利地找到可以使用的環境。</p>
<p>有了神兵利器，該是屠殺獵物的時刻。立即將我們使用的模型拿下去跑。然後…然後它就死了。GPU 的記憶體稱不過大量的文字向量表，真是沒用過不曉得記憶體使用的問題會這麼大。後來嘗試把訓練資料不斷縮小，縮小到剩 20mb 左右才跑得起來。不過即使是這樣的資料量，用 GPU 訓練起來還是需要一兩個小時。所以到此 RNN 就從比賽中出局啦。</p>
<p>剩下的時間就幫忙製作投影片，看一下其他組的成果。其中有一組<code>資料科科家</code>的成果非常驚人，在整場比賽裡丟出來的測試樣本都可以 100% 答對。我們的模型在測試過程中大概排第4名。</p>
<p>到了比賽時間，開始了第一輪淘汰賽。這時戲劇性的結果出現了，<code>資料科科家</code>在第一輪比賽時程式出了問題，沒有回答，結果就被刷掉了。每個參賽成員、主辦單位都大吃了一驚。頓時比賽變成了人人都有機會，一下子氣氛開始緊張起來。第一輪三次淘汰賽下，我們組別幸運地擠進前三名，準確度排第二。</p>
<p>第二輪比賽是採搶答方式，第一個回答正確才得分，累積10分為優勝者。這一輪比賽更刺激，因為大家的回答速度都很快，幾乎時間都只差一咪咪。不過我們沒有針對回答速度特別去調整，因此幾乎搶不到第一名回答，於是比賽過程不久就開始落後，成績都還掛0。當好不容易因前面組的失誤，才讓我們拿下一分時，全場都還鼓掌了起來，內心真的是頗感動的。後來劣勢一直都在，不過有幾次前面2組都答錯，只有我們答對，成了在比賽中的驕傲。</p>
<p>最後成績是我們排名第3名，雖然無法獲得更佳的名次有點可惜，不過已經超乎我們的預期。真是感謝組員的參與和付出。</p>
<p>附上報告組員的帥照。<br><img src="http://i.imgur.com/1PTGCHr.jpg" alt="Present"></p>
<p>比賽時各組的投影片：<br><a href="https://docs.google.com/spreadsheets/d/1q2uVExVaLyUMDubGet7e_MgKy9mdgo4MKZWY1YfH-48/edit#gid=0" target="_blank" rel="external">2016 PIXNET HACKATHON DEMO</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://raix852.github.io/2016/08/14/PixHack2016/" data-id="ciukybs4s000chype2va03957" class="article-share-link">Partager</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Deep-Learning/">Deep Learning</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Machine-Learning/">Machine Learning</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NLP/">NLP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/tensorflow/">tensorflow</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/日記/">日記</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-PixHack2016" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/07/29/PixHack2016/" class="article-date">
  <time datetime="2016-07-29T15:10:37.000Z" itemprop="datePublished">2016-07-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/07/29/PixHack2016/">7/29 痞客邦克漏字比賽紀錄</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近這陣子都熱心在學習 Deep learning 的東西，動機來自於和同事組隊參加 <code>2016 PIXNET HACKATHON Cloze Contest</code>。這個比賽會給出一句話，裡面會挖一個洞，並給出 4 個選項來選出符合這個洞的答案，也可以說是傳統的選擇題考試。對從小到大都是考試機器的我們來說是最常見不過的問題，因此都練出的一身本領來回答。但是對於機器來說，要選出正確答案還真不是件簡單的事，更可說是巨大的挑戰。</p>
<p>因此為了可以讓機器有辦法回答，需要有一些技巧來使用。以下紀錄目前我和同事做到的進度。正式比賽是在8/13 日，離比賽還有兩星期。</p>
<h2 id="爬取文章"><a href="#爬取文章" class="headerlink" title="爬取文章"></a>爬取文章</h2><p>在這個比賽裡，訓練資料集放出來是在 7/01 時，而我們準備的時間從 6 月初就開始，因此在沒有資料的情況下，我們就決定要開發爬網程式將痞客邦的文章抓取下來。這部分使用 <a href="http://scrapy.org/" target="_blank" rel="external">Scrapy</a> 來幫助我們開發爬網程式。</p>
<p>目前做到的成果為針對每天有被痞客邦視為熱門的文章抓取下來，並且順便將這些文章的作者曾經寫過的文章也一併抓取。跑一次爬網程式需要花費半天的時間，目前累積了將近 2G 的資料。不過現在的機制只是堪用，要做進一步改善還有很大的空間，只是考慮到接下來還有更困難的問題要解決，因此先開發到這邊。</p>
<h2 id="斷詞斷句"><a href="#斷詞斷句" class="headerlink" title="斷詞斷句"></a>斷詞斷句</h2><p>將文章抓取下來後，接下來使用 <a href="https://github.com/fxsjy/jieba" target="_blank" rel="external">Jieba</a> 來幫助我們做斷詞。這裏就直接使用現成的工具，因此不是太困難的工作。當然使用過程中會看到很多奇奇怪怪的字詞出現，這就需要人工介入將一些字詞濾掉。</p>
<h2 id="Word2vec"><a href="#Word2vec" class="headerlink" title="Word2vec"></a>Word2vec</h2><p>將上面斷出來的字詞整理出一個字詞庫出來，接下來要做的動作是把字詞變成向量。根據 Word2vec 演算法，字詞轉成向量後會有一些有趣的相關性，像是 <code>國王 - 男人 + 女人 = 皇后</code>。因此要完成這次的競賽，其實用 Word2vec 就可以做到不錯的成果，把選項的向量拿去和題目比對相似度，把最高相似度的選項當作正確答案，就會是一個不錯的解題模型。目前有組員利用這個方法做到 6 成正確率。</p>
<h2 id="RNN-LSTM"><a href="#RNN-LSTM" class="headerlink" title="RNN/LSTM"></a>RNN/LSTM</h2><p>這部分就是真正的挑戰啦，對於我這個初學者而言，要跟很多不熟悉的演算法和公式搏鬥。而且要處理部落格文章並拿去訓練也很不容易。基本上要面對龐大的字詞庫，動輒幾十萬的字詞，要算出每個字的機率出來，光想就覺得困難重重。目前這塊還在努力中，希望可以真的玩出一個模型出來。</p>
<h2 id="感想"><a href="#感想" class="headerlink" title="感想"></a>感想</h2><p>在這個比賽裡，由於接觸到的東西很多且都頗有挑戰性，所以做起來其實滿快樂的。學到很多東西，感覺很過癮。在目前工作上覺得進展有點停滯的時刻，弄這些東西真的有如及時雨一般滋潤我的內心，邊做邊感到持續有在進步中。希望到時能做出不錯的結果出來！</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://raix852.github.io/2016/07/29/PixHack2016/" data-id="ciukybs4p000ahypevnccadcu" class="article-share-link">Partager</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Deep-Learning/">Deep Learning</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Machine-Learning/">Machine Learning</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NLP/">NLP</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-data-at-rest" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/07/01/data-at-rest/" class="article-date">
  <time datetime="2016-07-01T15:10:37.000Z" itemprop="datePublished">2016-07-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/07/01/data-at-rest/">Data at rest encryption</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>目前一般的 data at rest encryption 有三種方式，分別為：</p>
<ol>
<li><p>Encrypted drives</p>
<p> 獨立於作業系統之外，由硬體提供加密的功能。避免硬體遺失時資料被輕易拿出，缺點是無法避免系統運行時被惡意使用者或惡意程序拿取資料。</p>
</li>
<li><p>Full disk encryption</p>
<p> 在這種模式下不需要硬體支援，可針對 disk 或 volume 整個加密。實作方式各家 filesystem 都有不同，所以也有不同的限制，像是有的可以對 /root 資料夾加密，有的不行。缺點和 Encrypted drives 一樣無法避免 disk 或 volume 運行起來時被惡意使用者或惡意程序拿取資料。</p>
</li>
<li><p>Filesystem encryption</p>
<p> 又稱為 file/folder encryption 。此種方式可以讓使用者分別對某個檔案或資料夾加密，加密時也可選擇不同的 key ，因此優點就是可以避免上面兩種方式的缺點，讓惡意使用者或程序難以解讀內容。缺點是針對密碼控管需要注意，特別是加密很多東西時。</p>
<p> 其實我初看到 Filesystem encryption 名詞時還以為是對整個 filesystem 加密，不過後來查 wiki 看到別稱才明白是指什麼。</p>
</li>
</ol>
<h2 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h2><p><a href="https://en.wikipedia.org/wiki/Disk_encryption" target="_blank" rel="external">Disk encryption</a> <br><br><a href="https://en.wikipedia.org/wiki/Filesystem-level_encryption" target="_blank" rel="external">Filesystem-level encryption</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://raix852.github.io/2016/07/01/data-at-rest/" data-id="ciukybs4l0009hype4j3agv9f" class="article-share-link">Partager</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Encryption/">Encryption</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Filesystem/">Filesystem</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/">Linux</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-use-openssl-generate-certificate" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/06/20/use-openssl-generate-certificate/" class="article-date">
  <time datetime="2016-06-20T13:00:00.000Z" itemprop="datePublished">2016-06-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/20/use-openssl-generate-certificate/">使用 Openssl 建立憑證</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近工作上需要建立程式之間的 TLS 連線，而 TLS 之間的連線步驟需要驗證憑證 (Certificate) ，讓之間的加密連線可以成立。不過由於處於測試階段，需要自己產生憑證出來。因此學習使用 Openssl 來產生憑證，也藉此讓自已對 TLS 連線和憑證機制有更清楚的了解。</p>
<h2 id="TLS-介紹"><a href="#TLS-介紹" class="headerlink" title="TLS 介紹"></a>TLS 介紹</h2><p>傳輸層安全協議（Transport Layer Security，縮寫：TLS），前身為安全通訊協定（Secure Sockets Layer，縮寫：SSL），由網景公司 (Netscape) 開發出來用在 http 協定上，後來由 IETF 將 SSL 進行標準化，就是後來的 TLS 。</p>
<p>TLS 在建立連線時，會經過以下的步驟：</p>
<ol>
<li>client 送出 ClientHello 訊息給 server ，裡面包含可支援的 TLS protocol，一個由 client 端隨機產生的數字(隨機數字只用在此次連線期間，避免被封包重播攻擊)，以及支援的加密和壓縮演算法。</li>
<li>server 回應 ServerHello 訊息，提供要使用的 TLS protocol ，一個由 server 端隨機產生的數字，以及要使用的加密和壓縮演算法。</li>
<li>server 根據上面選擇的 TLS protocol 和加密及壓縮演算法，提供憑證給 client</li>
<li>client 驗證 server 提供的憑證，將憑證內的 public key 取出</li>
<li>利用 server 提供的 public key ，將 client 的憑證，沒有憑證則隨機產生的 public key ，加密送回。</li>
<li>雙方使用交換出來的資訊，產生一組通訊用的加解密方式，有對稱式或非對稱式，取決於採用哪種演算法。</li>
<li>連線建立。</li>
</ol>
<h2 id="使用-Openssl-產生憑證"><a href="#使用-Openssl-產生憑證" class="headerlink" title="使用 Openssl 產生憑證"></a>使用 Openssl 產生憑證</h2><p>以下描述使用 openssl 來產生可供 TLS 連線所需的憑證，主要參考 <a href="https://jamielinux.com/docs/openssl-certificate-authority/index.html" target="_blank" rel="external">OpenSSL Certificate Authority</a> 這個網站的步驟來一步一步執行，根據自己的需求修改設定。</p>
<h3 id="建立-root-憑證"><a href="#建立-root-憑證" class="headerlink" title="建立 root 憑證"></a>建立 root 憑證</h3><p>一般公開網路上憑證不會是自己產生的，因為網路傳輸過程中不能確保會不會被偽造或修改。因此為了有可靠的信任機制，於是就有了憑證機構 (Certificate Authority, CA) ，由憑證機構產生憑證。最上層憑證機構通常由被信任的第三方公正機關來擔任，然後對個人或公司團體產生憑證簽章，如此才能確保憑證可以不被修改。</p>
<p>以瀏覽器為例，存有一串信任的憑證機構，藉由檢視連線網站的憑證是否由這些憑證機構產生，來判別網站可否受信任，不信任情況下就會出現不安全連線的提示。</p>
<p>而對公司企業內的私人網路來說， 不需要透過第三方憑證機構，因此會由自己產生 root 憑證，往下建立一連串的認證階層。也因此 root 憑證必須保護好，放置在與網路隔絕的環境並只有特定人士可以存取。一般網路上的認證機構的 root 憑證會互相簽章，表示彼此信任，而自己產生的 root 憑證因沒有其他機關互相簽章，因此會是自我簽章的憑證。</p>
<h4 id="步驟："><a href="#步驟：" class="headerlink" title="步驟："></a>步驟：</h4><ol>
<li><p>產生 root key。</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">mkdir /root/ca</div><div class="line"><span class="built_in">cd</span> /root/ca</div><div class="line">openssl genrsa -aes256 -out private/ca.key.pem 4096</div><div class="line">chmod 400 private/ca.key.pem</div></pre></td></tr></table></figure>
</li>
<li><p>參照 <a href="https://jamielinux.com/docs/openssl-certificate-authority/appendix/root-configuration-file.html" target="_blank" rel="external">config</a> 產生 openssl.cnf</p>
</li>
<li><p>產生自我簽章的 root 憑證。</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">openssl req -config openssl.cnf \</div><div class="line">     -key private/ca.key.pem \</div><div class="line">     -new -x509 -days 7300 -sha256 -extensions v3_ca \</div><div class="line">     -subj <span class="string">"/C=TW/ST=Taipei/O=RAIX/OU=RAIX.IO/CN=raix.io.rootca/emailAddress=raix@mail.com"</span> \</div><div class="line">     -out certs/ca.cert.pem</div><div class="line">chmod 444 certs/ca.cert.pem</div></pre></td></tr></table></figure>
<p> root 憑證過期日期建議設定長一點，因為是最重要的環節，不太適合頻繁的過期造成整串憑證失效。</p>
<p> 另外因為是產生自我簽章的憑證，和接下來產生 intermediate 或 client/server 的 Certificate signing request (CSR) 指令多了 <code>-x509</code> 參數。</p>
</li>
<li><p>驗證 root 憑證</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">openssl x509 -noout -text -in certs/ca.cert.pem</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="建立-intermediate-憑證"><a href="#建立-intermediate-憑證" class="headerlink" title="建立 intermediate 憑證"></a>建立 intermediate 憑證</h3><p>intermediate 憑證介於 root 和 client server 之間，可避免 root 憑證直接被使用，也可用來分群組，區分可使用的範圍。</p>
<h4 id="步驟"><a href="#步驟" class="headerlink" title="步驟"></a>步驟</h4><ol>
<li><p>設置相關資料夾和資訊</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">mkdir /root/ca/intermediate</div><div class="line"><span class="built_in">cd</span> /root/ca/intermediate</div><div class="line">mkdir certs crl csr newcerts private</div><div class="line">chmod 744 private</div><div class="line">touch index.txt</div><div class="line"><span class="built_in">echo</span> 1000 &gt; serial</div><div class="line"><span class="built_in">echo</span> 1000 &gt; crlnumber</div></pre></td></tr></table></figure>
</li>
<li><p>產生 intermediate key</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">openssl genrsa -aes256 \</div><div class="line">     -out private/intermediate.key.pem 4096</div><div class="line">chmod 400 private/intermediate.key.pem</div></pre></td></tr></table></figure>
</li>
<li><p>修改 openssl.cnf 產生 openssl-im.cnf</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[ CA_default ]</div><div class="line">dir             = /root/ca/intermediate</div><div class="line">private_key     = $dir/private/intermediate.key.pem</div><div class="line">certificate     = $dir/certs/intermediate.cert.pem</div><div class="line">crl             = $dir/crl/intermediate.crl.pem</div><div class="line">policy          = policy_loose</div></pre></td></tr></table></figure>
</li>
<li><p>產生 intermediate CSR</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">openssl req -config openssl-im.cnf -new -sha256 \</div><div class="line">     -subj <span class="string">"/C=TW/ST=Taipei/O=RAIX/OU=RAIX.IO/CN=raix.io.imca/emailAddress=raix@mail.com"</span>\</div><div class="line">     -key private/intermediate.key.pem \</div><div class="line">     -out csr/intermediate.csr.pem</div></pre></td></tr></table></figure>
<p> <a href="https://en.wikipedia.org/wiki/Certificate_signing_request" target="_blank" rel="external">Certificate signing request (CSR)</a> 裡紀錄個人或組織的資訊，並且提供給憑證機構簽章。</p>
</li>
<li><p>對 intermediate CSR 簽上 root 憑證，產生 intermediate 憑證</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">openssl ca -config /root/ca/openssl.cnf -extensions v3_intermediate_ca \</div><div class="line">     -days 3650 -notext -md sha256 \</div><div class="line">     -in csr/intermediate.csr.pem \</div><div class="line">     -out certs/intermediate.cert.pem</div><div class="line">chmod 444 certs/intermediate.cert.pem</div></pre></td></tr></table></figure>
</li>
<li><p>驗證 intermediate 憑證</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">openssl x509 -noout -text \</div><div class="line">     -in intermediate/certs/intermediate.cert.pem</div><div class="line">openssl verify -CAfile certs/ca.cert.pem \</div><div class="line">     intermediate/certs/intermediate.cert.pem</div></pre></td></tr></table></figure>
</li>
<li><p>產生憑證鍊 (certificate chain)</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">cat intermediate/certs/intermediate.cert.pem \</div><div class="line">     certs/ca.cert.pem &gt; intermediate/certs/ca-chain.cert.pem</div><div class="line">chmod 444 intermediate/certs/ca-chain.cert.pem</div></pre></td></tr></table></figure>
<p> 當應用程式要驗證 intermediate 憑證時，也需要同時驗證 root 憑證，因此需要產生憑證鍊來完成一整串驗證。</p>
</li>
</ol>
<h3 id="建立-client-server-憑證"><a href="#建立-client-server-憑證" class="headerlink" title="建立 client/server 憑證"></a>建立 client/server 憑證</h3><p>最後就是對要使用的 client/server 產生憑證，讓彼此之間 TLS 連線可以成立，確保處於安全的連線下。</p>
<h4 id="步驟-1"><a href="#步驟-1" class="headerlink" title="步驟"></a>步驟</h4><ol>
<li><p>產生 client/server key</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /root/ca/intermediate/</div><div class="line">openssl genrsa -out private/client.raix.io.key.pem 2048</div><div class="line">chmod 444 private/client.raix.io.key.pem</div></pre></td></tr></table></figure>
</li>
<li><p>產生 client/server CSR</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">openssl req -config openssl-im.cnf \</div><div class="line">     -key intermediate/private/client.raix.io.key.pem \</div><div class="line">     -subj <span class="string">"/C=TW/ST=Taipei/O=RAIX/OU=RAIX.IO/CN=client.raix.io/emailAddress=raix@mail.com"</span> \</div><div class="line">     -new -sha256 -out client.raix.io.csr.pem</div></pre></td></tr></table></figure>
</li>
<li><p>產生 client/server 憑證</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">openssl ca -config openssl-im.cnf \</div><div class="line">     -extensions server_cert -days 375 -notext -md sha256 \</div><div class="line">     -in intermediate/csr/client.raix.io.csr.pem \</div><div class="line">     -out intermediate/certs/client.raix.io.cert.pem</div><div class="line">chmod 444 certs/client.raix.io.cert.pem</div></pre></td></tr></table></figure>
</li>
<li><p>驗證憑證</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">openssl x509 -noout -text \</div><div class="line">     -in certs/client.raix.io.cert.pem</div><div class="line">openssl verify -CAfile intermediate/certs/ca-chain.cert.pem \</div><div class="line">     certs/client.raix.io.cert.pem</div></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h2><p>Wiki: <a href="https://en.wikipedia.org/wiki/Transport_Layer_Security" target="_blank" rel="external">Transport Layer Security</a> <br><br>Wiki: <a href="https://en.wikipedia.org/wiki/Certificate_authority" target="_blank" rel="external">Certificate authority</a> <br><br>Wiki: <a href="https://en.wikipedia.org/wiki/Certificate_signing_request" target="_blank" rel="external">Certificate signing request</a> <br><br><a href="https://jamielinux.com/docs/openssl-certificate-authority/index.html" target="_blank" rel="external">OpenSSL Certificate Authority</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://raix852.github.io/2016/06/20/use-openssl-generate-certificate/" data-id="ciukybs4j0007hypeyno7q638" class="article-share-link">Partager</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TLS/">TLS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/openssl/">openssl</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Python-decorator-property" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/06/04/Python-decorator-property/" class="article-date">
  <time datetime="2016-06-04T13:38:52.000Z" itemprop="datePublished">2016-06-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/04/Python-decorator-property/">Python - @property</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>今天在 trace 一個 python 專案時，看到類似 getter/setter 函式，不過實際使用時卻不像其他語言的 getter/setter 用法。於是就去 google 一下，找到 @property 的用法。</p>
<p>原來，在 python class 中，因為沒有 private 變數，全部都是 public ，任何人都可以存取，頂多只有透過命名風格在變數前加 ‘_‘ 或 ‘__‘ ，讓別人了解這個變數是給內部使用，不建議直接呼叫。也因此 getter/setter 的設計模式在 python 較沒意義，取而代之的是使用 @property 裝飾器(decorator)來達到類似的效果。</p>
<h3 id="範例-1"><a href="#範例-1" class="headerlink" title="範例 1"></a>範例 1</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/python</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Example</span><span class="params">(object)</span>:</span></div><div class="line">    _text = <span class="string">'This is an origin string'</span></div><div class="line"></div><div class="line"><span class="meta">    @property</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">text</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self._text</div><div class="line"></div><div class="line"><span class="meta">    @text.setter</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">text</span><span class="params">(self, string)</span>:</span></div><div class="line">        <span class="keyword">if</span> isinstance(string, str):</div><div class="line">            self._text = string</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">raise</span> TypeError(<span class="string">'%s url must be str, got %s:'</span> % (type(self).__name__,</div><div class="line">                type(url).__name__))</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    ex = Example()</div><div class="line">    string = <span class="string">'This is a test'</span></div><div class="line"></div><div class="line">    <span class="keyword">print</span> <span class="string">'Get Example.text: %s'</span> % (ex.text)</div><div class="line"></div><div class="line">    <span class="keyword">print</span> <span class="string">'Set Example.text: %s'</span> % (string)</div><div class="line">    ex.text = string</div><div class="line"></div><div class="line">    <span class="keyword">print</span> <span class="string">'Get Example.text: %s'</span> % (ex.text)</div></pre></td></tr></table></figure>
<h3 id="執行結果"><a href="#執行結果" class="headerlink" title="執行結果"></a>執行結果</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ ./decorator_property.py</div><div class="line">Get Example.text: This is an origin string</div><div class="line">Set Example.text: This is a <span class="built_in">test</span></div><div class="line">Get Example.text: This is a <span class="built_in">test</span></div></pre></td></tr></table></figure>
<p>不過在 trace 的 python 專案中，用的是另一種方法。</p>
<h3 id="範例-2"><a href="#範例-2" class="headerlink" title="範例 2"></a>範例 2</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/python</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Example</span><span class="params">(object)</span>:</span></div><div class="line">    _text = <span class="string">'This is an origin string'</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_get_text</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self._text</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_set_text</span><span class="params">(self, string)</span>:</span></div><div class="line">        <span class="keyword">if</span> isinstance(string, str):</div><div class="line">            self._text = string</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">raise</span> TypeError(<span class="string">'%s url must be str, got %s:'</span> % (type(self).__name__,</div><div class="line">                type(url).__name__))</div><div class="line"></div><div class="line">    text = property(_get_text, _set_text)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    ex = Example()</div><div class="line">    string = <span class="string">'This is a test'</span></div><div class="line"></div><div class="line">    <span class="keyword">print</span> <span class="string">'Get Example.text: %s'</span> % (ex.text)</div><div class="line"></div><div class="line">    <span class="keyword">print</span> <span class="string">'Set Example.text: %s'</span> % (string)</div><div class="line">    ex.text = string</div><div class="line"></div><div class="line">    <span class="keyword">print</span> <span class="string">'Get Example.text: %s'</span> % (ex.text)</div></pre></td></tr></table></figure>
<h3 id="執行結果-1"><a href="#執行結果-1" class="headerlink" title="執行結果"></a>執行結果</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ ./decorator_property_2.py</div><div class="line">Get Example.text: This is an origin string</div><div class="line">Set Example.text: This is a <span class="built_in">test</span></div><div class="line">Get Example.text: This is a <span class="built_in">test</span></div></pre></td></tr></table></figure>
<p>可以看到兩種寫法都可以達到相同的效果，而且用 <code>type(ex.text)</code> 看型態都是 <code>&lt;type &#39;str&#39;&gt;</code> 。</p>
<p>至於哪種寫法比較好？就本人覺得，比較偏好範例 2 ，畢竟可以對應到其他語言的寫法，相較之下可讀性較高。</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ol>
<li><a href="http://www.liaoxuefeng.com/wiki/001374738125095c955c1e6d8bb493182103fac9270762a000/001386820062641f3bcc60a4b164f8d91df476445697b9e000" target="_blank" rel="external">使用@property</a></li>
<li><a href="http://stackoverflow.com/questions/6618002/python-property-versus-getters-and-setters" target="_blank" rel="external">Python @property versus getters and setters</a></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://raix852.github.io/2016/06/04/Python-decorator-property/" data-id="ciukybs4f0005hypeyy8cn4d9" class="article-share-link">Partager</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/">python</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Mot-clés</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Deep-Learning/">Deep Learning</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Encryption/">Encryption</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Filesystem/">Filesystem</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Github/">Github</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kubernetes/">Kubernetes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Machine-Learning/">Machine Learning</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NLP/">NLP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TLS/">TLS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Udacity/">Udacity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openssl/">openssl</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tensorflow/">tensorflow</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/學習筆記/">學習筆記</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/日記/">日記</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/讀書心得/">讀書心得</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Nuage de mot-clés</h3>
    <div class="widget tagcloud">
      <a href="/tags/Deep-Learning/" style="font-size: 15px;">Deep Learning</a> <a href="/tags/Encryption/" style="font-size: 10px;">Encryption</a> <a href="/tags/Filesystem/" style="font-size: 10px;">Filesystem</a> <a href="/tags/Github/" style="font-size: 15px;">Github</a> <a href="/tags/Kubernetes/" style="font-size: 20px;">Kubernetes</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/Machine-Learning/" style="font-size: 15px;">Machine Learning</a> <a href="/tags/NLP/" style="font-size: 15px;">NLP</a> <a href="/tags/TLS/" style="font-size: 10px;">TLS</a> <a href="/tags/Udacity/" style="font-size: 20px;">Udacity</a> <a href="/tags/docker/" style="font-size: 20px;">docker</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/openssl/" style="font-size: 10px;">openssl</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/tensorflow/" style="font-size: 15px;">tensorflow</a> <a href="/tags/學習筆記/" style="font-size: 20px;">學習筆記</a> <a href="/tags/日記/" style="font-size: 15px;">日記</a> <a href="/tags/讀書心得/" style="font-size: 10px;">讀書心得</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">九月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">七月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">六月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">五月 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Articles récents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/10/22/Microservices/">Scalable Microservices with Kubernetes - Lesson 3</a>
          </li>
        
          <li>
            <a href="/2016/10/12/Microservices/">Scalable Microservices with Kubernetes - Lesson 2</a>
          </li>
        
          <li>
            <a href="/2016/10/11/Microservices/">Scalable Microservices with Kubernetes - Lesson 1</a>
          </li>
        
          <li>
            <a href="/2016/09/13/read-report/">台灣史上最有梗的台灣史</a>
          </li>
        
          <li>
            <a href="/2016/08/21/tensorflow-gpu-installation/">Tensorflow gtx 1060 installation</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 Raix<br>
      Propulsé by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>